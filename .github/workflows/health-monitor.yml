name: 3AM Pager - Health Monitor & Auto-Remediation

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:

env:
  PRODUCTION_API_URL: ${{ vars.PRODUCTION_API_URL || 'https://wcagaii.railway.app' }}

jobs:
  health_monitor:
    name: Continuous Health Monitoring
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Queue Depth
        id: check_queue
        run: |
          QUEUE_DEPTH=$(curl -s ${{ env.PRODUCTION_API_URL }}/metrics | grep 'wcagai_queue_length{' | awk '{print $2}' | head -1)
          echo "queue_depth=$QUEUE_DEPTH" >> $GITHUB_OUTPUT

          if [[ "$QUEUE_DEPTH" -gt 100 ]]; then
            echo "âŒ CRITICAL: Queue depth is $QUEUE_DEPTH (threshold: 100)"
            echo "queue_critical=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Queue depth OK: $QUEUE_DEPTH"
            echo "queue_critical=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Error Rate
        id: check_errors
        run: |
          ERROR_RATE=$(curl -s ${{ env.PRODUCTION_API_URL }}/metrics | grep 'wcagai_scans_total{status="error"' | awk '{print $2}')
          TOTAL_SCANS=$(curl -s ${{ env.PRODUCTION_API_URL }}/metrics | grep 'wcagai_scans_total' | awk '{print $2}' | awk '{s+=$1} END {print s}')

          if [[ "$TOTAL_SCANS" -gt 0 ]]; then
            ERROR_PERCENT=$(echo "scale=2; ($ERROR_RATE / $TOTAL_SCANS) * 100" | bc)
            echo "error_rate=$ERROR_PERCENT" >> $GITHUB_OUTPUT

            if (( $(echo "$ERROR_PERCENT > 10" | bc -l) )); then
              echo "âŒ CRITICAL: Error rate is $ERROR_PERCENT% (threshold: 10%)"
              echo "error_critical=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Error rate OK: $ERROR_PERCENT%"
              echo "error_critical=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Check AI Model Drift
        id: check_drift
        run: |
          DRIFT=$(curl -s ${{ env.PRODUCTION_API_URL }}/metrics | grep 'wcagai_ai_model_drift' | awk '{print $2}' | sort -n | tail -1)
          echo "drift_score=$DRIFT" >> $GITHUB_OUTPUT

          if (( $(echo "$DRIFT > 0.30" | bc -l) )); then
            echo "âš ï¸  WARNING: Model drift detected: $DRIFT (threshold: 0.30)"
            echo "drift_warning=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Model drift OK: $DRIFT"
            echo "drift_warning=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Browser Pool Utilization
        id: check_pool
        run: |
          UTILIZATION=$(curl -s ${{ env.PRODUCTION_API_URL }}/metrics | grep 'wcagai_browser_pool_utilization' | awk '{print $2}')
          echo "pool_utilization=$UTILIZATION" >> $GITHUB_OUTPUT

          if (( $(echo "$UTILIZATION > 90" | bc -l) )); then
            echo "âš ï¸  WARNING: Browser pool at $UTILIZATION% capacity"
            echo "pool_warning=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Browser pool OK: $UTILIZATION%"
            echo "pool_warning=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Railway CLI
        if: steps.check_queue.outputs.queue_critical == 'true'
        run: |
          echo "ðŸ“¦ Installing Railway CLI..."
          npm install -g @railway/cli
          echo "âœ… Railway CLI installed"

      - name: Auto-Remediate Queue Issues
        if: steps.check_queue.outputs.queue_critical == 'true'
        id: auto_remediate
        run: |
          echo "ðŸ”§ Auto-remediating queue issues..."
          REMEDIATION_SUCCESS=false

          # Trigger queue drain
          echo "Attempting to drain queue..."
          if curl -X POST ${{ env.PRODUCTION_API_URL }}/api/admin/queue/drain \
            -H "Authorization: Bearer ${{ secrets.ADMIN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"reason": "automated_health_check", "max_workers": 10}' \
            --fail --silent --show-error; then
            echo "âœ… Queue drain initiated successfully"
          else
            echo "âš ï¸  Queue drain API call failed, continuing with other remediation steps"
          fi

          # Scale up workers temporarily using Railway CLI
          echo "Attempting to scale up workers..."
          if railway variables set MAX_POOL_SIZE=10 --service=wcagaii-backend 2>/dev/null; then
            echo "âœ… Worker pool scaled up"
          else
            echo "âš ï¸  Railway scaling failed (Railway CLI or credentials may not be available)"
          fi

          sleep 60

          # Check if remediation worked
          NEW_DEPTH=$(curl -s ${{ env.PRODUCTION_API_URL }}/metrics | grep 'wcagai_queue_length' | awk '{print $2}' | head -1 || echo "0")

          if [[ "$NEW_DEPTH" -lt 50 ]]; then
            echo "âœ… Auto-remediation successful: Queue depth now $NEW_DEPTH"
            REMEDIATION_SUCCESS=true
            echo "remediation_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Auto-remediation failed: Queue still at $NEW_DEPTH"
            echo "remediation_status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Auto-Rollback Model on Drift
        if: steps.check_drift.outputs.drift_warning == 'true'
        id: model_rollback
        run: |
          echo "ðŸ”„ Auto-rolling back AI model due to drift..."

          # Disable shadow model in LaunchDarkly
          if curl -X PATCH https://app.launchdarkly.com/api/v2/flags/default/ai-shadow-deployment-enabled \
            -H "Authorization: ${{ secrets.LAUNCHDARKLY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "patch": [
                {
                  "op": "replace",
                  "path": "/environments/production/on",
                  "value": false
                }
              ]
            }' \
            --fail --silent --show-error; then
            echo "âœ… Shadow model disabled successfully"
            echo "rollback_status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Model rollback failed (LaunchDarkly API may be unavailable)"
            echo "rollback_status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Send PagerDuty Alert - Queue Critical
        if: steps.check_queue.outputs.queue_critical == 'true'
        uses: PagerDuty/pagerduty-change-events-action@v1.1.0
        with:
          integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          custom-event: |
            {
              "routing_key": "${{ secrets.PAGERDUTY_INTEGRATION_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "Queue depth critical: ${{ steps.check_queue.outputs.queue_depth }}",
                "severity": "critical",
                "source": "GitHub Actions Health Monitor",
                "component": "Queue",
                "custom_details": {
                  "queue_depth": "${{ steps.check_queue.outputs.queue_depth }}",
                  "threshold": "100",
                  "auto_remediation": "attempted"
                }
              }
            }

      - name: Send PagerDuty Alert - Error Rate High
        if: steps.check_errors.outputs.error_critical == 'true'
        uses: PagerDuty/pagerduty-change-events-action@v1.1.0
        with:
          integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          custom-event: |
            {
              "routing_key": "${{ secrets.PAGERDUTY_INTEGRATION_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "Error rate elevated: ${{ steps.check_errors.outputs.error_rate }}%",
                "severity": "error",
                "source": "GitHub Actions Health Monitor",
                "component": "API"
              }
            }

      - name: Send PagerDuty Alert - Model Drift
        if: steps.check_drift.outputs.drift_warning == 'true'
        uses: PagerDuty/pagerduty-change-events-action@v1.1.0
        with:
          integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          custom-event: |
            {
              "routing_key": "${{ secrets.PAGERDUTY_INTEGRATION_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "AI model drift detected: ${{ steps.check_drift.outputs.drift_score }}",
                "severity": "warning",
                "source": "GitHub Actions Health Monitor",
                "component": "AI Model",
                "custom_details": {
                  "drift_score": "${{ steps.check_drift.outputs.drift_score }}",
                  "threshold": "0.30",
                  "auto_remediation": "shadow_model_disabled"
                }
              }
            }

      - name: Create Incident Report
        if: |
          steps.check_queue.outputs.queue_critical == 'true' ||
          steps.check_errors.outputs.error_critical == 'true'
        run: |
          TIMESTAMP=$(date -Iseconds)
          INCIDENT_ID="INC-$(date +%Y%m%d%H%M%S)"
          
          # Ensure incident-reports directory exists
          mkdir -p incident-reports

          cat > "incident-reports/$INCIDENT_ID.md" <<EOF
          # Incident Report: $INCIDENT_ID

          **Timestamp:** $TIMESTAMP
          **Severity:** Critical
          **Detected By:** Automated Health Monitor

          ## Metrics at Time of Incident
          - Queue Depth: ${{ steps.check_queue.outputs.queue_depth }}
          - Error Rate: ${{ steps.check_errors.outputs.error_rate }}%
          - Model Drift: ${{ steps.check_drift.outputs.drift_score }}
          - Pool Utilization: ${{ steps.check_pool.outputs.pool_utilization }}%

          ## Auto-Remediation Actions Taken
          - Queue drain initiated: ${{ steps.auto_remediate.outputs.remediation_status || 'skipped' }}
          - Worker pool scaled to 10: ${{ steps.auto_remediate.outputs.remediation_status || 'skipped' }}
          - Shadow model disabled: ${{ steps.check_drift.outputs.drift_warning == 'true' && 'yes' || 'no' }}

          ## Manual Follow-up Required
          - [ ] Review error logs
          - [ ] Check for upstream API issues
          - [ ] Validate auto-remediation success
          - [ ] Update runbooks if new failure mode discovered

          ## Timeline
          - $TIMESTAMP: Issue detected
          - $TIMESTAMP: Auto-remediation initiated
          - $TIMESTAMP: PagerDuty alert sent

          EOF

          echo "ðŸ“ Incident report created: $INCIDENT_ID"

      - name: Upload Incident Report
        if: |
          steps.check_queue.outputs.queue_critical == 'true' ||
          steps.check_errors.outputs.error_critical == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: incident-report-${{ github.run_id }}
          path: incident-reports/*.md
          retention-days: 30

      - name: Create GitHub Issue for Manual Intervention
        if: |
          steps.check_queue.outputs.queue_critical == 'true' ||
          steps.check_errors.outputs.error_critical == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString();
            const status = '${{ steps.auto_remediate.outputs.remediation_status || 'not_attempted' }}';
            const queueDepth = '${{ steps.check_queue.outputs.queue_depth }}';
            const errorRate = '${{ steps.check_errors.outputs.error_rate }}';
            
            const issueBody = `## Production Health Issue

**Status:** ${status === 'success' ? 'recovered' : 'needs attention'}
**Auto-remediation:** ${status === 'success' ? 'Succeeded' : 'Failed'}
**Time:** ${timestamp}

**Action Required:** ${status === 'success' ? 'Verify system stability' : 'Manual intervention needed to restore service health'}

**Metrics:**
- Queue Depth: ${queueDepth || 'N/A'}
- Error Rate: ${errorRate || 'N/A'}%
- Model Drift: ${{ steps.check_drift.outputs.drift_score || 'N/A' }}
- Pool Utilization: ${{ steps.check_pool.outputs.pool_utilization || 'N/A' }}%

**Health Report:** Check [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed health report.

**Auto-Remediation Actions Taken:**
- Queue drain: ${status !== 'not_attempted' ? 'Attempted' : 'Not attempted'}
- Worker scaling: ${status !== 'not_attempted' ? 'Attempted' : 'Not attempted'}
- Model rollback: ${{ steps.check_drift.outputs.drift_warning == 'true' ? 'Attempted' : 'Not needed' }}

**Next Steps:**
1. Review the incident report in workflow artifacts
2. Check application logs for root cause
3. Verify system recovery if auto-remediation succeeded
4. Update runbooks if this is a new failure pattern`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production Health Alert - Auto-remediation ${status === 'success' ? 'Succeeded' : 'Failed'}`,
              body: issueBody,
              labels: ['production', 'health-check', 'automated']
            });

      - name: Summary
        if: always()
        run: |
          echo "## Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status Overview:**" >> $GITHUB_STEP_SUMMARY
          echo "- Queue Depth: ${{ steps.check_queue.outputs.queue_depth || 'N/A' }} (Critical: ${{ steps.check_queue.outputs.queue_critical || 'false' }})" >> $GITHUB_STEP_SUMMARY
          echo "- Error Rate: ${{ steps.check_errors.outputs.error_rate || 'N/A' }}% (Critical: ${{ steps.check_errors.outputs.error_critical || 'false' }})" >> $GITHUB_STEP_SUMMARY
          echo "- Model Drift: ${{ steps.check_drift.outputs.drift_score || 'N/A' }} (Warning: ${{ steps.check_drift.outputs.drift_warning || 'false' }})" >> $GITHUB_STEP_SUMMARY
          echo "- Pool Utilization: ${{ steps.check_pool.outputs.pool_utilization || 'N/A' }}% (Warning: ${{ steps.check_pool.outputs.pool_warning || 'false' }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-Remediation Status:** ${{ steps.auto_remediate.outputs.remediation_status || 'not_attempted' }}" >> $GITHUB_STEP_SUMMARY
