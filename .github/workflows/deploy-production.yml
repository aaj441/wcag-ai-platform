name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: packages/api/package-lock.json

      - name: Install dependencies
        run: |
          cd packages/api
          npm ci

      - name: Run security tests
        run: |
          cd packages/api
          JWT_SECRET=test-secret npm run dev &
          sleep 10
          JWT_SECRET=test-secret ./scripts/test-security.sh || exit 1

      - name: Check for secrets in code
        run: |
          # Simple check for common secret patterns
          if grep -r -E "(sk_live_|sk_test_|pk_live_|pk_test_|AKIA|-----BEGIN)" packages/api/src/; then
            echo "❌ Potential secrets found in code!"
            exit 1
          fi

      - name: Verify environment variable template
        run: |
          if [ ! -f .env.production.example ]; then
            echo "❌ .env.production.example not found!"
            exit 1
          fi

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        run: railway up --service wcag-api
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployment
        run: sleep 30

  post-deployment-verification:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Verify health endpoint
        run: |
          curl -f ${{ secrets.PRODUCTION_API_URL }}/health || exit 1

      - name: Check security headers
        run: |
          HEADERS=$(curl -I ${{ secrets.PRODUCTION_API_URL }}/health)

          if echo "$HEADERS" | grep -q "Strict-Transport-Security"; then
            echo "✅ HSTS header present"
          else
            echo "❌ HSTS header missing"
            exit 1
          fi

          if echo "$HEADERS" | grep -q "X-Frame-Options"; then
            echo "✅ X-Frame-Options present"
          else
            echo "❌ X-Frame-Options missing"
            exit 1
          fi

      - name: Run production security tests
        run: |
          cd packages/api
          API_URL=${{ secrets.PRODUCTION_API_URL }} \
          JWT_SECRET=${{ secrets.JWT_SECRET }} \
          ./scripts/test-security.sh

      - name: Notify on success
        if: success()
        run: |
          echo "✅ Production deployment successful and verified!"
          # Add Slack/Discord notification here

      - name: Rollback on failure
        if: failure()
        run: |
          echo "❌ Deployment verification failed! Consider rollback."
          # Add rollback logic or notification here
