name: Automated Secret Rotation

on:
  schedule:
    # Run on the 1st of every month at 2 AM UTC
    - cron: '0 2 1 * *'
  workflow_dispatch:
    inputs:
      secret_name:
        description: 'Specific secret to rotate (leave empty for all)'
        required: false
        type: string

env:
  AUDIT_LOG_PATH: './secret-rotation-audit.log'

jobs:
  rotate-secrets:
    name: Rotate Critical Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: write
      secrets: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Initialize Audit Log
        run: |
          echo "=== Secret Rotation Started ===" >> $AUDIT_LOG_PATH
          echo "Timestamp: $(date -Iseconds)" >> $AUDIT_LOG_PATH
          echo "Triggered by: ${{ github.event_name }}" >> $AUDIT_LOG_PATH
          echo "Actor: ${{ github.actor }}" >> $AUDIT_LOG_PATH
          echo "================================" >> $AUDIT_LOG_PATH

      - name: Rotate OpenAI API Key
        id: rotate-openai
        if: |
          github.event.inputs.secret_name == '' || 
          github.event.inputs.secret_name == 'OPENAI_API_KEY'
        run: |
          echo "üîÑ Rotating OpenAI API Key..."
          
          # Generate new API key via OpenAI API
          # Note: In production, this would make an actual API call to OpenAI
          # For now, we'll simulate with a placeholder
          NEW_KEY="sk-proj-$(openssl rand -hex 32)"
          OLD_KEY_LAST_4="${{ secrets.OPENAI_API_KEY }}"
          OLD_KEY_LAST_4="${OLD_KEY_LAST_4: -4}"
          
          echo "new_key=$NEW_KEY" >> $GITHUB_OUTPUT
          echo "old_key_last_4=$OLD_KEY_LAST_4" >> $GITHUB_OUTPUT
          
          # Log rotation
          echo "OpenAI API Key rotated" >> $AUDIT_LOG_PATH
          echo "  Old key (last 4): $OLD_KEY_LAST_4" >> $AUDIT_LOG_PATH
          echo "  New key (last 4): ${NEW_KEY: -4}" >> $AUDIT_LOG_PATH
          echo "  Timestamp: $(date -Iseconds)" >> $AUDIT_LOG_PATH
          
          echo "‚úÖ OpenAI API key rotation complete"

      - name: Update OpenAI Secret in GitHub
        if: steps.rotate-openai.outcome == 'success'
        uses: gliech/create-github-secret-action@v1
        with:
          name: OPENAI_API_KEY
          value: ${{ steps.rotate-openai.outputs.new_key }}
          pa_token: ${{ secrets.GH_PAT_SECRET_MANAGEMENT }}

      - name: Update OpenAI Key in Railway
        if: steps.rotate-openai.outcome == 'success'
        run: |
          echo "üöÇ Updating OpenAI key in Railway..."
          npm install -g @railway/cli
          
          railway variables set OPENAI_API_KEY="${{ steps.rotate-openai.outputs.new_key }}" \
            --service=wcagaii-backend \
            --environment=production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Rotate Database Password
        id: rotate-db-password
        if: |
          github.event.inputs.secret_name == '' || 
          github.event.inputs.secret_name == 'DB_PASSWORD'
        run: |
          echo "üîÑ Rotating Database Password..."
          
          # Generate strong random password
          NEW_PASSWORD="$(openssl rand -base64 32 | tr -d '=+/' | cut -c1-32)"
          
          echo "new_password=$NEW_PASSWORD" >> $GITHUB_OUTPUT
          
          # Log rotation (don't log actual password)
          echo "Database Password rotated" >> $AUDIT_LOG_PATH
          echo "  Timestamp: $(date -Iseconds)" >> $AUDIT_LOG_PATH
          
          echo "‚úÖ Database password rotation complete"

      - name: Update Database Password
        if: steps.rotate-db-password.outcome == 'success'
        run: |
          echo "Updating database password..."
          
          # Update in GitHub Secrets
          # This would use GitHub API in production
          
          # Update in Railway
          railway variables set DB_PASSWORD="${{ steps.rotate-db-password.outputs.new_password }}" \
            --service=wcagaii-backend \
            --environment=production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Rotate Admin API Key
        id: rotate-admin-key
        if: |
          github.event.inputs.secret_name == '' || 
          github.event.inputs.secret_name == 'ADMIN_API_KEY'
        run: |
          echo "üîÑ Rotating Admin API Key..."
          
          # Generate new admin API key
          NEW_ADMIN_KEY="admin_$(openssl rand -hex 32)"
          
          echo "new_admin_key=$NEW_ADMIN_KEY" >> $GITHUB_OUTPUT
          
          # Log rotation
          echo "Admin API Key rotated" >> $AUDIT_LOG_PATH
          echo "  Timestamp: $(date -Iseconds)" >> $AUDIT_LOG_PATH
          
          echo "‚úÖ Admin API key rotation complete"

      - name: Update Admin API Key
        if: steps.rotate-admin-key.outcome == 'success'
        run: |
          echo "Updating Admin API key..."
          
          railway variables set ADMIN_API_KEY="${{ steps.rotate-admin-key.outputs.new_admin_key }}" \
            --service=wcagaii-backend \
            --environment=production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Rotate JWT Secret
        id: rotate-jwt-secret
        if: |
          github.event.inputs.secret_name == '' || 
          github.event.inputs.secret_name == 'JWT_SECRET'
        run: |
          echo "üîÑ Rotating JWT Secret..."
          
          # Generate new JWT secret
          NEW_JWT_SECRET="$(openssl rand -base64 64 | tr -d '\n')"
          
          echo "new_jwt_secret=$NEW_JWT_SECRET" >> $GITHUB_OUTPUT
          
          # Log rotation
          echo "JWT Secret rotated" >> $AUDIT_LOG_PATH
          echo "  Timestamp: $(date -Iseconds)" >> $AUDIT_LOG_PATH
          echo "  ‚ö†Ô∏è  NOTE: Old JWT tokens will be invalidated" >> $AUDIT_LOG_PATH
          
          echo "‚úÖ JWT secret rotation complete"

      - name: Update JWT Secret
        if: steps.rotate-jwt-secret.outcome == 'success'
        run: |
          echo "Updating JWT secret..."
          
          railway variables set JWT_SECRET="${{ steps.rotate-jwt-secret.outputs.new_jwt_secret }}" \
            --service=wcagaii-backend \
            --environment=production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify New Secrets Work
        run: |
          echo "üîç Verifying new secrets..."
          sleep 30  # Wait for services to restart with new secrets
          
          # Health check with new secrets
          HEALTH_URL="${{ vars.PRODUCTION_API_URL }}/health"
          MAX_ATTEMPTS=5
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f -s "$HEALTH_URL" > /dev/null; then
              echo "‚úÖ Health check passed with new secrets"
              echo "Secret verification: PASSED" >> $AUDIT_LOG_PATH
              exit 0
            fi
            ATTEMPT=$((ATTEMPT+1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS failed, retrying in 10s..."
            sleep 10
          done
          
          echo "‚ùå Health check failed after secret rotation"
          echo "Secret verification: FAILED" >> $AUDIT_LOG_PATH
          exit 1

      - name: Finalize Audit Log
        if: always()
        run: |
          echo "================================" >> $AUDIT_LOG_PATH
          echo "Status: ${{ job.status }}" >> $AUDIT_LOG_PATH
          echo "Completed: $(date -Iseconds)" >> $AUDIT_LOG_PATH
          echo "=== Secret Rotation Completed ===" >> $AUDIT_LOG_PATH

      - name: Upload Audit Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-rotation-audit-${{ github.run_id }}
          path: ${{ env.AUDIT_LOG_PATH }}
          retention-days: 90

      - name: Commit Audit Log to Repository
        if: success()
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          mkdir -p audit-logs
          cp $AUDIT_LOG_PATH "audit-logs/rotation-$(date +%Y%m%d-%H%M%S).log"
          
          git add audit-logs/
          git commit -m "chore: Add secret rotation audit log [automated]" || true
          git push || true

      - name: Send Success Notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "‚úÖ Automated Secret Rotation Completed Successfully",
              "attachments": [{
                "color": "good",
                "fields": [
                  {
                    "title": "Timestamp",
                    "value": "${{ github.event.head_commit.timestamp }}",
                    "short": true
                  },
                  {
                    "title": "Secrets Rotated",
                    "value": "OpenAI API Key, Database Password, Admin API Key, JWT Secret",
                    "short": false
                  },
                  {
                    "title": "Audit Log",
                    "value": "Available in GitHub Actions artifacts",
                    "short": true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Send Failure Notification
        if: failure()
        uses: PagerDuty/pagerduty-change-events-action@v1.1.0
        with:
          integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          custom-event: |
            {
              "routing_key": "${{ secrets.PAGERDUTY_ROUTING_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "URGENT: Automated Secret Rotation Failed",
                "severity": "critical",
                "source": "GitHub Actions - Secret Rotation",
                "component": "security-automation",
                "custom_details": {
                  "workflow_run": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "triggered_by": "${{ github.actor }}",
                  "timestamp": "${{ github.event.head_commit.timestamp }}"
                }
              }
            }

  rollback-on-failure:
    name: Rollback Secrets on Failure
    needs: rotate-secrets
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Rollback to Previous Secrets
        run: |
          echo "üîÑ Rolling back to previous secrets..."
          
          # This would restore from a backup of previous secret values
          # In production, you'd have a secure backup mechanism
          
          echo "‚ö†Ô∏è  Manual intervention required to restore previous secrets"
          echo "Check audit logs for details"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Notify Team of Rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "üö® Secret Rotation Failed - Manual Rollback Required",
              "attachments": [{
                "color": "danger",
                "fields": [
                  {
                    "title": "Action Required",
                    "value": "Manually restore previous secrets from backup",
                    "short": false
                  },
                  {
                    "title": "Workflow Run",
                    "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                    "short": false
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
