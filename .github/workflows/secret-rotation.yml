name: Automated Secret Rotation

on:
  schedule:
    - cron: '0 0 1 * *'  # Monthly on the 1st at midnight UTC
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  id-token: write

jobs:
  rotate_openai_key:
    name: Rotate OpenAI API Key
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Generate new OpenAI key
        id: new_key
        run: |
          # Note: OpenAI doesn't have an API for key rotation yet
          # This is a placeholder for when they do
          echo "âš ï¸  OpenAI key rotation requires manual process"
          echo "   Visit: https://platform.openai.com/account/api-keys"
          echo "manual_rotation_required=true" >> $GITHUB_OUTPUT

      - name: Notify for manual rotation
        if: steps.new_key.outputs.manual_rotation_required == 'true'
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H "Content-Type: application/json" \
            -d '{
              "text": "ðŸ” Monthly OpenAI API key rotation reminder",
              "attachments": [{
                "color": "warning",
                "text": "Please manually rotate the OpenAI API key:\n1. Create new key at https://platform.openai.com/account/api-keys\n2. Update Railway environment variable\n3. Delete old key after 24 hours"
              }]
            }'

  rotate_jwt_secret:
    name: Rotate JWT Secret
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate new JWT secret
        id: jwt
        run: |
          NEW_SECRET=$(openssl rand -base64 64)
          echo "::add-mask::$NEW_SECRET"
          echo "new_secret=$NEW_SECRET" >> $GITHUB_OUTPUT

      - name: Update Railway environment
        run: |
          npm install -g @railway/cli

          # Set new JWT secret
          railway variables set JWT_SECRET="${{ steps.jwt.outputs.new_secret }}" \
            --service=wcagaii-backend \
            --environment=production

          echo "âœ… JWT secret rotated"

      - name: Trigger zero-downtime redeploy
        run: |
          # Wait for env var propagation
          sleep 30

          # Redeploy backend
          railway up --service=wcagaii-backend --environment=production

          echo "âœ… Backend redeployed with new JWT secret"

  rotate_database_password:
    name: Rotate Database Password
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate new database password
        id: db_pass
        run: |
          NEW_PASSWORD=$(openssl rand -base64 32)
          echo "::add-mask::$NEW_PASSWORD"
          echo "new_password=$NEW_PASSWORD" >> $GITHUB_OUTPUT

      - name: Update database password
        run: |
          # Connect to Railway PostgreSQL
          railway run --service=wcagaii-postgres psql \$DATABASE_URL \
            -c "ALTER USER wcagaii WITH PASSWORD '${{ steps.db_pass.outputs.new_password }}';"

          echo "âœ… Database password updated"

      - name: Update connection strings
        run: |
          # Update DATABASE_URL in backend service
          OLD_URL=$(railway variables get DATABASE_URL --service=wcagaii-backend)
          NEW_URL=$(echo "$OLD_URL" | sed "s/:.*@/:${{ steps.db_pass.outputs.new_password }}@/")

          railway variables set DATABASE_URL="$NEW_URL" \
            --service=wcagaii-backend \
            --environment=production

          echo "âœ… Connection string updated"

      - name: Restart backend
        run: |
          railway up --service=wcagaii-backend --environment=production
          sleep 60

          # Health check
          curl -f ${{ vars.PRODUCTION_API_URL }}/health || exit 1

          echo "âœ… Backend restarted successfully"

  rotate_signing_key:
    name: Rotate Audit Log Signing Key
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate new RSA keypair
        id: rsa
        run: |
          # Generate new RSA private key
          openssl genrsa -out private_key_new.pem 4096

          # Extract public key
          openssl rsa -in private_key_new.pem -pubout -out public_key_new.pem

          # Base64 encode for environment variable
          PRIVATE_KEY_B64=$(cat private_key_new.pem | base64 -w 0)
          PUBLIC_KEY_B64=$(cat public_key_new.pem | base64 -w 0)

          echo "::add-mask::$PRIVATE_KEY_B64"

          # Store in AWS Secrets Manager
          aws secretsmanager put-secret-value \
            --secret-id prod/wcagaii/signing-private-key \
            --secret-string "$PRIVATE_KEY_B64"

          aws secretsmanager put-secret-value \
            --secret-id prod/wcagaii/signing-public-key \
            --secret-string "$PUBLIC_KEY_B64"

          echo "âœ… New signing keys stored in AWS Secrets Manager"

      - name: Update Railway environment
        run: |
          # Fetch from Secrets Manager and set in Railway
          PRIVATE_KEY=$(aws secretsmanager get-secret-value \
            --secret-id prod/wcagaii/signing-private-key \
            --query SecretString \
            --output text)

          railway variables set SIGNING_PRIVATE_KEY="$PRIVATE_KEY" \
            --service=wcagaii-backend \
            --environment=production

          echo "âœ… Signing key updated"

      - name: Archive old key
        run: |
          # Store old key with version tag
          TIMESTAMP=$(date +%Y%m%d)

          aws secretsmanager put-secret-value \
            --secret-id prod/wcagaii/signing-private-key-archived-$TIMESTAMP \
            --secret-string "$(railway variables get SIGNING_PRIVATE_KEY)"

          echo "âœ… Old key archived"

  audit_rotation:
    name: Audit Secret Rotation
    needs: [rotate_jwt_secret, rotate_database_password, rotate_signing_key]
    runs-on: ubuntu-latest
    steps:
      - name: Log rotation to audit trail
        run: |
          TIMESTAMP=$(date -Iseconds)

          # Send to audit log service
          curl -X POST ${{ vars.PRODUCTION_API_URL }}/api/admin/audit \
            -H "Authorization: Bearer ${{ secrets.ADMIN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "secret_rotation_completed",
              "timestamp": "'$TIMESTAMP'",
              "rotated_secrets": ["jwt_secret", "database_password", "signing_key"],
              "rotation_type": "automated_monthly"
            }'

          echo "âœ… Rotation logged to audit trail"

      - name: Notify team
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H "Content-Type: application/json" \
            -d '{
              "text": "ðŸ” Monthly secret rotation completed successfully",
              "attachments": [{
                "color": "good",
                "fields": [
                  {"title": "JWT Secret", "value": "âœ… Rotated", "short": true},
                  {"title": "Database Password", "value": "âœ… Rotated", "short": true},
                  {"title": "Signing Key", "value": "âœ… Rotated", "short": true},
                  {"title": "OpenAI Key", "value": "âš ï¸  Manual required", "short": true}
                ]
              }]
            }'

          echo "âœ… Team notified"

      - name: Create rotation report
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          cat > "rotation-report-$TIMESTAMP.md" <<EOF
          # Secret Rotation Report

          **Date:** $(date -Iseconds)
          **Rotation Type:** Automated Monthly

          ## Rotated Secrets
          - âœ… JWT Secret
          - âœ… Database Password
          - âœ… Audit Log Signing Key
          - âš ï¸  OpenAI API Key (manual rotation required)

          ## Verification
          - Health checks: Passed
          - Backend restart: Successful
          - Audit trail: Logged

          ## Next Rotation
          Scheduled for: $(date -d "+1 month" +%Y-%m-%d)

          ## Manual Steps Required
          1. Rotate OpenAI API key at https://platform.openai.com/account/api-keys
          2. Update Railway environment variable
          3. Verify API functionality
          4. Delete old key after 24 hours
          EOF

          echo "ðŸ“ Rotation report created"
