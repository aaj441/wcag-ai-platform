name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  pull-requests: read

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: /language:${{ matrix.language }}

  secrets-scanning:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-audit:
    name: NPM Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate || true

      - name: Audit root
        run: npm audit --audit-level=moderate

      - name: Audit packages/api
        run: |
          cd packages/api
          npm audit --audit-level=moderate || true

      - name: Audit packages/webapp
        run: |
          cd packages/webapp
          npm audit --audit-level=moderate || true

  snyk-scan:
    name: Snyk Dependency Check
    runs-on: ubuntu-latest
    if: ${{ secrets.SNYK_TOKEN != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Snyk scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

  eslint-security:
    name: ESLint Security Rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint --if-present || true

  security-headers:
    name: Security Headers Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for security headers
        run: |
          # Check for CSP headers
          grep -r "Content-Security-Policy" packages/ || echo "‚ö†Ô∏è  No CSP headers found"
          # Check for HSTS headers
          grep -r "Strict-Transport-Security" packages/ || echo "‚ö†Ô∏è  No HSTS headers found"

  sast-scan:
    name: SAST Scan (SonarQube)
    runs-on: ubuntu-latest
    if: ${{ secrets.SONAR_TOKEN != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true

  report-summary:
    name: Security Report Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [codeql, secrets-scanning, dependency-audit, eslint-security]

    steps:
      - name: Create security summary
        run: |
          echo "## üîí Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ CodeQL Analysis: Complete" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Secret Detection: Complete" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Dependency Audit: Complete" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ ESLint Security: Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For detailed results, review the action logs above." >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    name: Notify on Security Issues
    runs-on: ubuntu-latest
    if: failure()
    needs: [codeql, secrets-scanning, dependency-audit]

    steps:
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è  Security scan found issues. Please review the scan results above.'
            })
