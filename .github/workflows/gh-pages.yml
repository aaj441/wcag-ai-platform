name: Deploy GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/gh-pages.yml'
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    name: Build GitHub Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create docs directory structure
        run: |
          mkdir -p _site

          # Copy HTML files
          if [ -d "docs" ]; then
            cp -r docs/* _site/
          fi

          # Convert markdown files to accessible locations
          mkdir -p _site/docs

          # Copy markdown documentation
          [ -f "SECURITY.md" ] && cp SECURITY.md _site/docs/
          [ -f "CONTRIBUTING.md" ] && cp CONTRIBUTING.md _site/docs/
          [ -f "API_DOCUMENTATION.md" ] && cp API_DOCUMENTATION.md _site/docs/
          [ -f "BUILD_TROUBLESHOOTING.md" ] && cp BUILD_TROUBLESHOOTING.md _site/docs/
          [ -f "WORKFLOW_FIXES.md" ] && cp WORKFLOW_FIXES.md _site/docs/
          [ -f "README.md" ] && cp README.md _site/docs/

          echo "‚úÖ Documentation structure created"

      - name: Create markdown viewer HTML
        run: |
          cat > _site/docs/viewer.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>WCAG AI Platform - Documentation</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
              <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
              <style>
                  body {
                      max-width: 980px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #f6f8fa;
                  }
                  .markdown-body {
                      background: white;
                      padding: 45px;
                      border-radius: 6px;
                      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
                  }
                  .doc-nav {
                      background: white;
                      padding: 20px;
                      margin-bottom: 20px;
                      border-radius: 6px;
                      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
                  }
                  .doc-nav a {
                      margin-right: 15px;
                      color: #0366d6;
                      text-decoration: none;
                  }
                  .doc-nav a:hover {
                      text-decoration: underline;
                  }
              </style>
          </head>
          <body>
              <div class="doc-nav">
                  <a href="../index.html">‚Üê Back to Home</a>
                  <a href="?doc=SECURITY.md">Security</a>
                  <a href="?doc=CONTRIBUTING.md">Contributing</a>
                  <a href="?doc=API_DOCUMENTATION.md">API Docs</a>
                  <a href="?doc=BUILD_TROUBLESHOOTING.md">Troubleshooting</a>
                  <a href="?doc=WORKFLOW_FIXES.md">Workflows</a>
                  <a href="?doc=README.md">README</a>
              </div>
              <div class="markdown-body" id="content">
                  <p>Loading documentation...</p>
              </div>
              <script>
                  const params = new URLSearchParams(window.location.search);
                  const doc = params.get('doc') || 'README.md';

                  fetch(doc)
                      .then(response => response.text())
                      .then(markdown => {
                          document.getElementById('content').innerHTML = marked.parse(markdown);
                          document.title = doc.replace('.md', '') + ' - WCAG AI Platform';
                      })
                      .catch(error => {
                          document.getElementById('content').innerHTML =
                              '<h1>Error Loading Documentation</h1><p>Could not load ' + doc + '</p>';
                      });
              </script>
          </body>
          </html>
          EOF

          echo "‚úÖ Markdown viewer created"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Post deployment summary
        run: |
          echo "‚úÖ GitHub Pages deployed successfully"
          echo "üìÑ Documentation URL: ${{ steps.deployment.outputs.page_url }}"
