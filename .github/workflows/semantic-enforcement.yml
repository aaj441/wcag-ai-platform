name: Semantic API Enforcement

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/api/**/*.ts'
      - 'packages/api/**/*.js'
      - 'backend/**/*.ts'
      - 'backend/**/*.js'
  push:
    branches: [main]

jobs:
  detect-breaking-changes:
    name: Detect Breaking API Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g @microsoft/api-extractor
          npm install -g typescript

      - name: Extract API surface from main branch
        run: |
          git checkout origin/main
          
          # Extract API signatures
          find packages/api/src -name "*.ts" -type f > api-files.txt
          
          # Generate API documentation
          mkdir -p /tmp/api-baseline
          for file in $(cat api-files.txt); do
            echo "Processing $file..."
            tsc --declaration --emitDeclarationOnly --outDir /tmp/api-baseline "$file" 2>/dev/null || true
          done
          
          # Create API inventory
          find /tmp/api-baseline -name "*.d.ts" -exec cat {} \; > /tmp/api-baseline.txt

      - name: Extract API surface from PR branch
        run: |
          git checkout ${{ github.head_ref || github.ref_name }}
          
          # Extract API signatures from current branch
          mkdir -p /tmp/api-current
          for file in $(cat api-files.txt 2>/dev/null || find packages/api/src -name "*.ts"); do
            echo "Processing $file..."
            tsc --declaration --emitDeclarationOnly --outDir /tmp/api-current "$file" 2>/dev/null || true
          done
          
          # Create API inventory
          find /tmp/api-current -name "*.d.ts" -exec cat {} \; > /tmp/api-current.txt

      - name: Analyze API changes
        id: analyze
        run: |
          cat > /tmp/analyze-api-changes.js <<'EOF'
          const fs = require('fs');
          
          const baseline = fs.readFileSync('/tmp/api-baseline.txt', 'utf8');
          const current = fs.readFileSync('/tmp/api-current.txt', 'utf8');
          
          const changes = {
            breaking: [],
            additions: [],
            deprecations: []
          };
          
          // Simple heuristics for breaking changes
          const baselineLines = new Set(baseline.split('\n').filter(l => l.trim()));
          const currentLines = new Set(current.split('\n').filter(l => l.trim()));
          
          // Detect removed exports (breaking)
          baselineLines.forEach(line => {
            if (line.includes('export') && !currentLines.has(line)) {
              changes.breaking.push({
                type: 'removed',
                signature: line.trim()
              });
            }
          });
          
          // Detect new exports (additions)
          currentLines.forEach(line => {
            if (line.includes('export') && !baselineLines.has(line)) {
              changes.additions.push({
                type: 'added',
                signature: line.trim()
              });
            }
          });
          
          console.log(JSON.stringify(changes, null, 2));
          
          // Write results
          fs.writeFileSync('/tmp/api-changes.json', JSON.stringify(changes, null, 2));
          
          // Exit with error if breaking changes detected
          if (changes.breaking.length > 0) {
            console.error(`\nðŸš¨ ${changes.breaking.length} breaking changes detected!`);
            process.exit(1);
          }
          EOF
          
          node /tmp/analyze-api-changes.js || echo "breaking_changes_detected=true" >> $GITHUB_OUTPUT

      - name: Generate migration guide
        if: steps.analyze.outputs.breaking_changes_detected == 'true'
        run: |
          cat > /tmp/migration-guide.md <<'EOF'
          # API Migration Guide
          
          ## Breaking Changes Detected
          
          This PR introduces breaking changes to the public API. Please review and update your code accordingly.
          
          ## Changes
          
          EOF
          
          # Append detected changes
          if [ -f /tmp/api-changes.json ]; then
            node -e "
              const changes = require('/tmp/api-changes.json');
              changes.breaking.forEach(c => {
                console.log('### Removed: ' + c.signature);
                console.log('');
                console.log('**Migration:** Update your code to use the new equivalent API.');
                console.log('');
              });
            " >> /tmp/migration-guide.md
          fi
          
          echo '## Need Help?' >> /tmp/migration-guide.md
          echo '' >> /tmp/migration-guide.md
          echo 'Contact the API team for migration assistance.' >> /tmp/migration-guide.md

      - name: Upload migration guide
        if: steps.analyze.outputs.breaking_changes_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: api-migration-guide
          path: /tmp/migration-guide.md

      - name: Comment on PR with breaking changes
        if: steps.analyze.outputs.breaking_changes_detected == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changes = JSON.parse(fs.readFileSync('/tmp/api-changes.json', 'utf8'));
            const migrationGuide = fs.readFileSync('/tmp/migration-guide.md', 'utf8');
            
            const body = `## âš ï¸ Breaking API Changes Detected
            
            This PR introduces **${changes.breaking.length} breaking change(s)** to the public API.
            
            ### Breaking Changes:
            ${changes.breaking.map(c => `- \`${c.signature}\``).join('\n')}
            
            ### Migration Guide
            
            A migration guide has been automatically generated and attached to this workflow run.
            
            ### Required Actions:
            
            1. Review all breaking changes
            2. Update documentation
            3. Create migration guide for users
            4. Consider deprecation period before removal
            5. Update CHANGELOG.md with breaking changes section
            
            ### Process:
            
            - [ ] Breaking changes documented
            - [ ] Migration guide created
            - [ ] Major version bump planned
            - [ ] Deprecation warnings added (if applicable)
            - [ ] Team notified
            
            ---
            
            <details>
            <summary>ðŸ“– Full Migration Guide</summary>
            
            ${migrationGuide}
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail workflow if breaking changes
        if: steps.analyze.outputs.breaking_changes_detected == 'true'
        run: |
          echo "ðŸš¨ Workflow failed due to breaking API changes"
          echo "Please review the migration guide and update the PR"
          exit 1

  enforce-deprecation-schedule:
    name: Enforce Deprecation Schedule
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for deprecated APIs past deadline
        run: |
          cat > /tmp/check-deprecations.js <<'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const warnings = [];
          const errors = [];
          
          function searchDeprecations(dir) {
            const files = fs.readdirSync(dir);
            
            files.forEach(file => {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);
              
              if (stat.isDirectory()) {
                searchDeprecations(filePath);
              } else if (file.endsWith('.ts') || file.endsWith('.js')) {
                const content = fs.readFileSync(filePath, 'utf8');
                const lines = content.split('\n');
                
                lines.forEach((line, index) => {
                  // Look for @deprecated tags
                  if (line.includes('@deprecated')) {
                    const match = line.match(/@deprecated.*?deadline:\s*(\d{4}-\d{2}-\d{2})/i);
                    if (match) {
                      const deadline = new Date(match[1]);
                      const now = new Date();
                      
                      if (deadline < now) {
                        errors.push({
                          file: filePath,
                          line: index + 1,
                          deadline: match[1],
                          content: line.trim()
                        });
                      }
                    }
                  }
                });
              }
            });
          }
          
          // Search for deprecations
          if (fs.existsSync('packages/api/src')) {
            searchDeprecations('packages/api/src');
          }
          if (fs.existsSync('backend/src')) {
            searchDeprecations('backend/src');
          }
          
          // Report results
          if (errors.length > 0) {
            console.error('\nðŸš¨ Found deprecated APIs past their removal deadline:\n');
            errors.forEach(e => {
              console.error(`  ${e.file}:${e.line}`);
              console.error(`    Deadline: ${e.deadline}`);
              console.error(`    ${e.content}\n`);
            });
            process.exit(1);
          } else {
            console.log('âœ… No deprecated APIs past deadline');
          }
          EOF
          
          node /tmp/check-deprecations.js

  api-documentation-check:
    name: Verify API Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for undocumented public APIs
        run: |
          cat > /tmp/check-docs.js <<'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const undocumented = [];
          
          function checkDocumentation(dir) {
            const files = fs.readdirSync(dir);
            
            files.forEach(file => {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);
              
              if (stat.isDirectory()) {
                checkDocumentation(filePath);
              } else if (file.endsWith('.ts') || file.endsWith('.js')) {
                const content = fs.readFileSync(filePath, 'utf8');
                const lines = content.split('\n');
                
                lines.forEach((line, index) => {
                  // Look for public exports without JSDoc
                  if (line.includes('export') && (line.includes('function') || line.includes('class'))) {
                    // Check if previous lines have JSDoc
                    let hasDoc = false;
                    for (let i = index - 1; i >= Math.max(0, index - 5); i--) {
                      if (lines[i].includes('/**') || lines[i].includes('*')) {
                        hasDoc = true;
                        break;
                      }
                    }
                    
                    if (!hasDoc) {
                      undocumented.push({
                        file: filePath,
                        line: index + 1,
                        content: line.trim()
                      });
                    }
                  }
                });
              }
            });
          }
          
          // Check documentation
          if (fs.existsSync('packages/api/src')) {
            checkDocumentation('packages/api/src');
          }
          
          if (undocumented.length > 0) {
            console.warn('\nâš ï¸  Found undocumented public APIs:\n');
            undocumented.forEach(item => {
              console.warn(`  ${item.file}:${item.line}`);
              console.warn(`    ${item.content}\n`);
            });
            console.warn(`Total: ${undocumented.length} undocumented APIs`);
            // Don't fail, just warn
          } else {
            console.log('âœ… All public APIs are documented');
          }
          EOF
          
          node /tmp/check-docs.js

  version-compatibility-check:
    name: Check Version Compatibility
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine required version bump
        id: version-bump
        run: |
          # Check if this PR requires a version bump
          if git diff origin/main --name-only | grep -E 'packages/api/.*\.(ts|js)$'; then
            echo "api_changed=true" >> $GITHUB_OUTPUT
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Comment version bump requirement
        if: steps.version-bump.outputs.api_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“¦ Version Bump Required
              
              This PR modifies the API and requires a version bump.
              
              Recommended bump: **${{ steps.version-bump.outputs.bump_type }}**
              
              Please update the version in \`package.json\` before merging.`
            });
