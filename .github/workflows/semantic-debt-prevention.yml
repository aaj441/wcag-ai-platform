name: Semantic Debt Prevention

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'

permissions:
  contents: read
  pull-requests: write

jobs:
  semantic-analysis:
    name: Semantic Change Detection
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect Breaking API Changes
        id: breaking_changes
        run: |
          echo "üîç Analyzing API changes..."

          # Count files with API changes
          API_CHANGES=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -E "api/.*\.(ts|js)" | wc -l)
          echo "api_changes=$API_CHANGES" >> $GITHUB_OUTPUT

          # Look for breaking change indicators
          BREAKING_PATTERNS="removeSync|deleteSync|breaking|BREAKING"
          BREAKING_COUNT=$(git diff origin/${{ github.base_ref }}...HEAD | grep -iE "$BREAKING_PATTERNS" | wc -l)
          echo "breaking_changes=$BREAKING_COUNT" >> $GITHUB_OUTPUT

          echo "API file changes: $API_CHANGES"
          echo "Potential breaking changes: $BREAKING_COUNT"

      - name: Detect Deprecated Code Usage
        id: deprecated
        run: |
          echo "üîç Checking for deprecated code..."

          # Find @deprecated annotations
          DEPRECATED_USAGE=$(grep -r "@deprecated" --include="*.ts" --include="*.js" packages/ | grep -v "node_modules" | wc -l || echo "0")
          echo "deprecated_usage=$DEPRECATED_USAGE" >> $GITHUB_OUTPUT

          # Check if deprecation dates have passed
          EXPIRED_DEPRECATIONS=0
          if [ "$DEPRECATED_USAGE" -gt 0 ]; then
            while IFS= read -r line; do
              # Extract date from @deprecated annotation (format: @deprecated 2025-01-01)
              DATE=$(echo "$line" | grep -oP '@deprecated\s+\K[0-9]{4}-[0-9]{2}-[0-9]{2}' || echo "")
              if [ -n "$DATE" ]; then
                if [[ $(date -d "$DATE" +%s) < $(date +%s) ]]; then
                  EXPIRED_DEPRECATIONS=$((EXPIRED_DEPRECATIONS + 1))
                  echo "‚ö†Ô∏è  Expired deprecation found: $line"
                fi
              fi
            done < <(grep -r "@deprecated" --include="*.ts" --include="*.js" packages/ | grep -v "node_modules")
          fi

          echo "expired_deprecations=$EXPIRED_DEPRECATIONS" >> $GITHUB_OUTPUT
          echo "Deprecated code usage: $DEPRECATED_USAGE"
          echo "Expired deprecations: $EXPIRED_DEPRECATIONS"

      - name: Check Code Complexity
        id: complexity
        run: |
          echo "üîç Analyzing code complexity..."

          # Install complexity analyzer and jq
          npm install -g complexity-report
          sudo apt-get update -y && sudo apt-get install -y jq || true

          # Analyze changed files
          CHANGED_FILES=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -E "\.(ts|js)$" | grep -v "node_modules" || echo "")

          HIGH_COMPLEXITY_FILES=0
          if [ -n "$CHANGED_FILES" ]; then
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                # get maintainability as a numeric value (default to 100 on error)
                COMPLEXITY=$(cr "$file" --format json 2>/dev/null | jq -r '.maintainability // 100' || echo "100")
                COMPLEXITY=${COMPLEXITY:-100}

                # numeric comparison using awk to avoid bc errors
                if awk "BEGIN {exit !($COMPLEXITY < 65)}"; then
                  HIGH_COMPLEXITY_FILES=$((HIGH_COMPLEXITY_FILES + 1))
                  echo "‚ö†Ô∏è  High complexity: $file (maintainability: $COMPLEXITY)"
                fi
              fi
            done <<< "$CHANGED_FILES"
          fi

          echo "high_complexity_files=$HIGH_COMPLEXITY_FILES" >> $GITHUB_OUTPUT
          echo "High complexity files: $HIGH_COMPLEXITY_FILES"

      - name: Check PR Size
        id: pr_size
        run: |
          # Calculate lines changed
          LINES_CHANGED=$(git diff origin/${{ github.base_ref }}...HEAD --shortstat | grep -oP '\d+(?= insertions?)' || echo "0")
          FILES_CHANGED=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | wc -l)

          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

          echo "Lines changed: $LINES_CHANGED"
          echo "Files changed: $FILES_CHANGED"

      - name: Enforce Deprecation Schedule
        if: steps.deprecated.outputs.expired_deprecations > 0
        run: |
          echo "‚ùå Found ${{ steps.deprecated.outputs.expired_deprecations }} expired deprecation(s)"
          echo "Please remove deprecated code before merging"

          # Comment on PR
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚ö†Ô∏è **Expired Deprecations Detected**

          This PR contains ${{ steps.deprecated.outputs.expired_deprecations }} expired \`@deprecated\` annotation(s).

          Please remove the deprecated code before merging.

          **How to fix:**
          1. Search for \`@deprecated\` annotations with dates in the past
          2. Remove the deprecated code and its references
          3. Update dependent code to use new alternatives"

          exit 1

      - name: Block Large PRs
        if: steps.pr_size.outputs.lines_changed > 1000 || steps.pr_size.outputs.files_changed > 50
        run: |
          echo "‚ö†Ô∏è Large PR detected:"
          echo "  Lines changed: ${{ steps.pr_size.outputs.lines_changed }}"
          echo "  Files changed: ${{ steps.pr_size.outputs.files_changed }}"

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚ö†Ô∏è **Large PR Detected**

          This PR is quite large:
          - Lines changed: ${{ steps.pr_size.outputs.lines_changed }}
          - Files changed: ${{ steps.pr_size.outputs.files_changed }}

          **Recommendations:**
          - Split into smaller, focused PRs
          - Each PR should address a single concern
          - Target: < 500 lines, < 20 files per PR

          If this PR cannot be split, please add a comment explaining why and request review from @senior-dev-team"

          # Add label
          gh pr edit ${{ github.event.pull_request.number }} --add-label "large-pr"

      - name: Warn on Breaking Changes
        if: steps.breaking_changes.outputs.breaking_changes > 0
        run: |
          echo "‚ö†Ô∏è Potential breaking changes detected: ${{ steps.breaking_changes.outputs.breaking_changes }}"

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚ö†Ô∏è **Potential Breaking Changes Detected**

          This PR may contain breaking changes (${{ steps.breaking_changes.outputs.breaking_changes }} indicators found).

          **Required actions:**
          1. Add migration guide to \`docs/migrations/\`
          2. Update API version if applicable
          3. Add \`BREAKING CHANGE:\` to commit message
          4. Get approval from 2+ senior developers

          **Breaking Change Checklist:**
          - [ ] Migration guide created
          - [ ] API version bumped
          - [ ] Backward compatibility considered
          - [ ] Deprecation period provided (if applicable)
          - [ ] Documentation updated"

          # Add label and request reviews
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "breaking-change" \
            --add-reviewer "senior-dev-team"

      - name: Check Code Complexity
        if: steps.complexity.outputs.high_complexity_files > 0
        run: |
          echo "‚ö†Ô∏è High complexity files detected: ${{ steps.complexity.outputs.high_complexity_files }}"

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚ö†Ô∏è **High Code Complexity Detected**

          ${{ steps.complexity.outputs.high_complexity_files }} file(s) have high complexity scores.

          **Recommendations:**
          - Break large functions into smaller, focused functions
          - Reduce nesting levels
          - Simplify conditional logic
          - Consider extracting helper functions

          Files with maintainability < 65 should be refactored before merging."

          # Add label
          gh pr edit ${{ github.event.pull_request.number }} --add-label "needs-refactoring"

      - name: Generate Technical Debt Report
        run: |
          echo "üìä Generating technical debt report..."

          cat > technical-debt-report.md <<EOF
          # Technical Debt Report - PR #${{ github.event.pull_request.number }}

          **Generated:** $(date -Iseconds)

          ## Summary
          - **API Changes:** ${{ steps.breaking_changes.outputs.api_changes }}
          - **Breaking Changes:** ${{ steps.breaking_changes.outputs.breaking_changes }}
          - **Deprecated Code:** ${{ steps.deprecated.outputs.deprecated_usage }}
          - **Expired Deprecations:** ${{ steps.deprecated.outputs.expired_deprecations }}
          - **High Complexity Files:** ${{ steps.complexity.outputs.high_complexity_files }}
          - **Lines Changed:** ${{ steps.pr_size.outputs.lines_changed }}
          - **Files Changed:** ${{ steps.pr_size.outputs.files_changed }}

          ## Risk Assessment
          $(if [ "${{ steps.breaking_changes.outputs.breaking_changes }}" -gt 0 ]; then
            echo "- ‚ö†Ô∏è **HIGH RISK**: Breaking changes detected"
          fi)
          $(if [ "${{ steps.deprecated.outputs.expired_deprecations }}" -gt 0 ]; then
            echo "- ‚ùå **BLOCKER**: Expired deprecations must be removed"
          fi)
          $(if [ "${{ steps.complexity.outputs.high_complexity_files }}" -gt 0 ]; then
            echo "- ‚ö†Ô∏è **MEDIUM RISK**: High complexity code added"
          fi)
          $(if [ "${{ steps.pr_size.outputs.lines_changed }}" -gt 1000 ]; then
            echo "- ‚ö†Ô∏è **REVIEW RISK**: Large PR (>1000 lines)"
          fi)

          ## Recommendations
          - Follow semantic versioning for API changes
          - Remove expired deprecated code
          - Refactor high-complexity functions
          - Split large PRs into smaller chunks
          - Add comprehensive tests for breaking changes

          ---
          Generated by semantic-debt-prevention.yml
          EOF

          cat technical-debt-report.md

      - name: Summary
        run: |
          echo "## Semantic Debt Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- API Changes: ${{ steps.breaking_changes.outputs.api_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- Breaking Changes: ${{ steps.breaking_changes.outputs.breaking_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deprecated Usage: ${{ steps.deprecated.outputs.deprecated_usage }}" >> $GITHUB_STEP_SUMMARY
          echo "- Expired Deprecations: ${{ steps.deprecated.outputs.expired_deprecations }}" >> $GITHUB_STEP_SUMMARY
          echo "- High Complexity Files: ${{ steps.complexity.outputs.high_complexity_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lines Changed: ${{ steps.pr_size.outputs.lines_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Files Changed: ${{ steps.pr_size.outputs.files_changed }}" >> $GITHUB_STEP_SUMMARY

  quarterly-deprecation-report:
    name: Quarterly Deprecation Report
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate deprecation report
        run: |
          echo "üìä Generating quarterly deprecation report..."

          # Find all deprecated code
          grep -r "@deprecated" --include="*.ts" --include="*.js" packages/ | \
            grep -v "node_modules" > /tmp/deprecated-code.txt || true

          # Parse and categorize
          TOTAL=$(wc -l < /tmp/deprecated-code.txt)
          EXPIRED=0
          EXPIRING_SOON=0

          while IFS= read -r line; do
            DATE=$(echo "$line" | grep -oP '@deprecated\s+\K[0-9]{4}-[0-9]{2}-[0-9]{2}' || echo "")
            if [ -n "$DATE" ]; then
              if [[ $(date -d "$DATE" +%s) < $(date +%s) ]]; then
                EXPIRED=$((EXPIRED + 1))
              elif [[ $(date -d "$DATE" +%s) < $(date -d "+30 days" +%s) ]]; then
                EXPIRING_SOON=$((EXPIRING_SOON + 1))
              fi
            fi
          done < /tmp/deprecated-code.txt

          echo "Quarterly Deprecation Report - Q$(date +%q) $(date +%Y)" > /tmp/deprecation-report.txt
          echo "=" >> /tmp/deprecation-report.txt
          echo "Total deprecated: $TOTAL" >> /tmp/deprecation-report.txt
          echo "Expired: $EXPIRED" >> /tmp/deprecation-report.txt
          echo "Expiring in 30 days: $EXPIRING_SOON" >> /tmp/deprecation-report.txt

          # Send to tech leads
          cat /tmp/deprecation-report.txt | mail -s "Q$(date +%q) Deprecation Report" tech-leads@company.com || true
