name: Enhanced Semantic Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  typescript-api-analysis:
    name: TypeScript API Change Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install TypeScript API Extractor
        run: npm install -g @microsoft/api-extractor

      - name: Extract API Surface (Base)
        run: |
          git checkout origin/${{ github.base_ref }}
          npx api-extractor run --local > base-api.json || echo "{}" > base-api.json

      - name: Extract API Surface (PR)
        run: |
          git checkout ${{ github.head_ref }}
          npx api-extractor run --local > pr-api.json || echo "{}" > pr-api.json

      - name: Detect Breaking Changes
        id: breaking
        run: |
          # Real semantic diff using TypeScript AST
          cat > detect-breaks.js <<'EOF'
          const fs = require('fs');
          const baseAPI = JSON.parse(fs.readFileSync('base-api.json', 'utf8'));
          const prAPI = JSON.parse(fs.readFileSync('pr-api.json', 'utf8'));

          const breaking = [];

          // Check for removed exports
          for (const name of Object.keys(baseAPI.exports || {})) {
            if (!prAPI.exports?.[name]) {
              breaking.push(`Removed export: ${name}`);
            }
          }

          // Check for signature changes
          for (const [name, baseFunc] of Object.entries(baseAPI.functions || {})) {
            const prFunc = prAPI.functions?.[name];
            if (prFunc && baseFunc.signature !== prFunc.signature) {
              breaking.push(`Changed signature: ${name}`);
            }
          }

          console.log(JSON.stringify({ breaking, count: breaking.length }));
          EOF

          node detect-breaks.js > breaking.json
          BREAKING_COUNT=$(jq '.count' breaking.json)
          echo "breaking_count=$BREAKING_COUNT" >> $GITHUB_OUTPUT

      - name: Comment PR with Results
        if: steps.breaking.outputs.breaking_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const breaking = require('./breaking.json');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ⚠️ Breaking API Changes Detected\n\n` +
                    breaking.breaking.map(b => `- ${b}`).join('\n') +
                    `\n\n**Action Required:** Bump major version or revert changes.`
            });

            if (breaking.count > 0) {
              core.setFailed(`Found ${breaking.count} breaking changes`);
            }
