name: Accessibility CI/CD Scanner

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  accessibility-scan:
    name: Scan for WCAG Violations
name: Accessibility Scan

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  accessibility:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm install -g axe-core puppeteer pa11y
          cd packages/api && npm install
          cd ../webapp && npm install
      
      - name: Build application
        run: |
          cd packages/api && npm run build
          cd ../webapp && npm run build
      
      - name: Start API server
        run: |
          cd packages/api
          npm start &
          API_PID=$!
          echo "API_PID=$API_PID" >> $GITHUB_ENV
          # Wait for server to start
          sleep 10
          curl http://localhost:3001/health || echo "API not ready yet"
      
      - name: Start web server
        run: |
          cd packages/webapp
          npm start &
          WEBAPP_PID=$!
          echo "WEBAPP_PID=$WEBAPP_PID" >> $GITHUB_ENV
          # Wait for server to start
          sleep 10
          curl http://localhost:3000 || echo "Webapp not ready yet"
      
      - name: Run axe-core accessibility scan
        id: axe-scan
        continue-on-error: true
        run: |
          node scripts/accessibility-scan.js http://localhost:3000 --output json > axe-results.json
          echo "exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Parse scan results
        id: parse-results
        run: |
          if [ -f axe-results.json ]; then
            CRITICAL=$(jq '.summary.critical' axe-results.json)
            HIGH=$(jq '.summary.high' axe-results.json)
            MEDIUM=$(jq '.summary.medium' axe-results.json)
            LOW=$(jq '.summary.low' axe-results.json)
            TOTAL=$(jq '.summary.total' axe-results.json)
            SCORE=$(jq '.complianceScore' axe-results.json)
            
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "score=$SCORE" >> $GITHUB_OUTPUT
          else
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "score=100" >> $GITHUB_OUTPUT
          fi
      
      - name: Save to Evidence Vault
        if: always()
        env:
          API_URL: http://localhost:3001
        run: |
          if [ -f axe-results.json ]; then
            # Use jq to properly escape JSON values
            COMMIT_SHA=$(echo "${{ github.sha }}" | jq -R .)
            BRANCH=$(echo "${{ github.ref_name }}" | jq -R .)
            
            curl -X POST http://localhost:3001/api/evidence/ci-scan \
              -H "Content-Type: application/json" \
              -d @- <<EOF
          {
            "prNumber": ${{ github.event.pull_request.number || 0 }},
            "commitSha": ${COMMIT_SHA},
            "branch": ${BRANCH},
            "passed": $([ "${{ steps.parse-results.outputs.critical }}" -eq 0 ] && echo "true" || echo "false"),
            "complianceScore": ${{ steps.parse-results.outputs.score }},
            "violations": $(cat axe-results.json | jq '.violations'),
            "criticalBlockers": ${{ steps.parse-results.outputs.critical }},
            "scanDurationMs": $(cat axe-results.json | jq '.scanDurationMs'),
            "tool": "axe-core"
          }
          EOF
          fi
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const critical = ${{ steps.parse-results.outputs.critical }};
            const high = ${{ steps.parse-results.outputs.high }};
            const medium = ${{ steps.parse-results.outputs.medium }};
            const low = ${{ steps.parse-results.outputs.low }};
            const total = ${{ steps.parse-results.outputs.total }};
            const score = ${{ steps.parse-results.outputs.score }};
            const passed = critical === 0;
            
            const statusIcon = passed ? '‚úÖ' : '‚ùå';
            const scoreColor = score >= 90 ? 'üü¢' : score >= 75 ? 'üü°' : 'üî¥';
            
            const comment = `## ${statusIcon} Accessibility Scan Results
            
            **Compliance Score:** ${scoreColor} **${score}%**
            
            ### Violations Summary
            
            | Severity | Count |
            |----------|-------|
            | üî¥ Critical | ${critical} |
            | üü† High | ${high} |
            | üü° Medium | ${medium} |
            | üü¢ Low | ${low} |
            | **Total** | **${total}** |
            
            ${critical > 0 ? `
            ### ‚ö†Ô∏è Critical Issues Must Be Fixed
            
            This PR has **${critical} critical accessibility issue(s)** that block users with disabilities.
            Please address these issues before merging.
            ` : ''}
            
            ${passed ? `
            ### ‚úÖ Status: PASSED
            
            No critical accessibility issues detected. Great job! üéâ
            ` : `
            ### ‚ùå Status: FAILED
            
            Critical accessibility issues detected. This PR cannot be merged until these are resolved.
            `}
            
            ---
            
            <details>
            <summary>üìö WCAG 2.2 AA Compliance</summary>
            
            This scan checks for compliance with:
            - WCAG 2.0 Level A & AA
            - WCAG 2.1 Level A & AA
            - WCAG 2.2 Level AA
            
            **Evidence Retention:** Results saved to Evidence Vault for 90 days
            
            **Tools Used:** axe-core automated scanner
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      - name: Install root dependencies
        run: npm install || npm ci --legacy-peer-deps

      - name: Install API dependencies
        working-directory: ./packages/api
        run: npm install || npm ci --legacy-peer-deps

      - name: Install webapp dependencies
        working-directory: ./packages/webapp
        run: npm install || npm ci --legacy-peer-deps

      - name: Install wait-on globally
        run: npm install -g wait-on
      
      - name: Build API
        working-directory: ./packages/api
        run: npm run build
      
      - name: Build webapp
        working-directory: ./packages/webapp
        run: npm run build
        env:
          VITE_API_BASE_URL: http://localhost:3001
      
      - name: Start API server
        working-directory: ./packages/api
        run: |
          npm start &
          echo $! > ../../api-server.pid
          wait-on http://localhost:3001/health --timeout 60000
        env:
          PORT: 3001
          NODE_ENV: test

      - name: Start webapp server
        working-directory: ./packages/webapp
        run: |
          npm start &
          echo $! > ../../webapp-server.pid
          wait-on http://localhost:3000 --timeout 60000
        env:
          PORT: 3000
      
      - name: Run axe-core accessibility scan
        run: node scripts/accessibility-scan.js http://localhost:3000
        continue-on-error: true
        id: axe-scan
      
      - name: Update evidence vault
        if: always()
        run: node scripts/update-evidence-vault.js
      
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-scan-results
          path: axe-results.json
          retention-days: 90
      
      - name: Fail if critical issues found
        if: steps.parse-results.outputs.critical != '0'
        run: |
          echo "‚ùå BLOCKING: Found ${{ steps.parse-results.outputs.critical }} critical accessibility issues"
          echo "These issues prevent users with disabilities from accessing content."
          echo "Please fix critical issues before merging."
          exit 1
      
      - name: Cleanup
        if: always()
        run: |
          if [ ! -z "$API_PID" ]; then
            kill $API_PID || true
          fi
          if [ ! -z "$WEBAPP_PID" ]; then
            kill $WEBAPP_PID || true
          name: accessibility-scan-results-${{ github.run_number }}
          path: evidence-vault/
          retention-days: 90
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              // Find the latest scan file
              const scansDir = 'evidence-vault/scans';
              if (!fs.existsSync(scansDir)) {
                console.log('No scan results found');
                return;
              }
              
              const files = fs.readdirSync(scansDir)
                .filter(f => f.startsWith('scan-') && f.endsWith('.json'))
                .sort()
                .reverse();
              
              if (files.length === 0) {
                console.log('No axe-core scan results found');
                return;
              }
              
              const latestFile = files[0];
              const results = JSON.parse(fs.readFileSync(path.join(scansDir, latestFile), 'utf8'));
              
              const violations = results.violations.length;
              const critical = results.violations.filter(v => v.impact === 'critical').length;
              const serious = results.violations.filter(v => v.impact === 'serious').length;
              const moderate = results.violations.filter(v => v.impact === 'moderate').length;
              const minor = results.violations.filter(v => v.impact === 'minor').length;
              const passes = results.passes.length;
              
              // Create violation details
              let violationDetails = '';
              if (violations > 0) {
                violationDetails = results.violations.slice(0, 5).map((v, i) => 
                  `${i + 1}. **${v.id}** (${v.impact})\n   - ${v.description}\n   - Affected elements: ${v.nodes.length}\n   - [Learn more](${v.helpUrl})`
                ).join('\n\n');
                
                if (violations > 5) {
                  violationDetails += `\n\n_... and ${violations - 5} more violations. See full report in artifacts._`;
                }
              }
              
              const statusEmoji = critical > 0 ? '‚ùå' : serious > 0 ? '‚ö†Ô∏è' : '‚úÖ';
              const statusText = critical > 0 ? 'BLOCKED - Critical violations must be fixed' : 
                                serious > 0 ? 'WARNING - Serious violations detected' : 
                                'PASSED - No critical violations';
              
              const comment = `## ${statusEmoji} Accessibility Scan Results
            
**Status:** ${statusText}

### Summary
| Category | Count |
|----------|-------|
| üî¥ Critical | **${critical}** |
| üü† Serious | **${serious}** |
| üü° Moderate | **${moderate}** |
| üü¢ Minor | **${minor}** |
| ‚úÖ Passed | **${passes}** |

### Impact
- **Total Violations:** ${violations}
- **Tests Passed:** ${passes}

${critical > 0 ? `
### ‚õî Action Required
This PR is **blocked** due to critical accessibility violations. Critical issues must be fixed before merging.
` : serious > 0 ? `
### ‚ö†Ô∏è Attention Needed
This PR has serious accessibility violations. Please review and fix before merging.
` : `
### ‚úÖ All Clear
No critical accessibility violations detected. Great work!
`}

${violations > 0 ? `
<details>
<summary>üìã View Top Violations</summary>

${violationDetails}

</details>
` : ''}

<details>
<summary>‚ÑπÔ∏è About This Check</summary>

This automated accessibility scan uses [axe-core](https://github.com/dequelabs/axe-core) to test for WCAG 2.1 Level A and AA compliance.

- **Critical**: Severe accessibility barriers that prevent access
- **Serious**: Significant barriers that impact many users
- **Moderate**: Noticeable barriers that affect some users  
- **Minor**: Minor issues that have minimal impact

Scan results are stored in the Evidence Vault for 90 days.

</details>

---
üìä **Scan ID:** \`${latestFile}\` | ‚è±Ô∏è **Runtime:** ${{ github.run_number }} | ü§ñ **Powered by axe-core**`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
            } catch (error) {
              console.error('Error creating comment:', error);
              // Don't fail the workflow if comment creation fails
            }
      
      - name: Stop servers
        if: always()
        run: |
          if [ -f api-server.pid ]; then
            kill $(cat api-server.pid) || true
            rm api-server.pid
          fi
          if [ -f webapp-server.pid ]; then
            kill $(cat webapp-server.pid) || true
            rm webapp-server.pid
          fi

      - name: Check scan status
        if: always()
        run: |
          if [ "${{ steps.axe-scan.outcome }}" == "failure" ]; then
            echo "‚ùå Accessibility scan failed - see results above"
            exit 1
          else
            echo "‚úÖ Accessibility scan passed"
          fi
