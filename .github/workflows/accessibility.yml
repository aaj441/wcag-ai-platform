name: Accessibility CI/CD Scanner

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  accessibility-scan:
    name: Scan for WCAG Violations
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm install -g axe-core puppeteer pa11y
          cd packages/api && npm install
          cd ../webapp && npm install
      
      - name: Build application
        run: |
          cd packages/api && npm run build
          cd ../webapp && npm run build
      
      - name: Start API server
        run: |
          cd packages/api
          npm start &
          API_PID=$!
          echo "API_PID=$API_PID" >> $GITHUB_ENV
          # Wait for server to start
          sleep 10
          curl http://localhost:3001/health || echo "API not ready yet"
      
      - name: Start web server
        run: |
          cd packages/webapp
          npm start &
          WEBAPP_PID=$!
          echo "WEBAPP_PID=$WEBAPP_PID" >> $GITHUB_ENV
          # Wait for server to start
          sleep 10
          curl http://localhost:3000 || echo "Webapp not ready yet"
      
      - name: Run axe-core accessibility scan
        id: axe-scan
        continue-on-error: true
        run: |
          node scripts/accessibility-scan.js http://localhost:3000 --output json > axe-results.json
          echo "exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Parse scan results
        id: parse-results
        run: |
          if [ -f axe-results.json ]; then
            CRITICAL=$(jq '.summary.critical' axe-results.json)
            HIGH=$(jq '.summary.high' axe-results.json)
            MEDIUM=$(jq '.summary.medium' axe-results.json)
            LOW=$(jq '.summary.low' axe-results.json)
            TOTAL=$(jq '.summary.total' axe-results.json)
            SCORE=$(jq '.complianceScore' axe-results.json)
            
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "score=$SCORE" >> $GITHUB_OUTPUT
          else
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "score=100" >> $GITHUB_OUTPUT
          fi
      
      - name: Save to Evidence Vault
        if: always()
        env:
          API_URL: http://localhost:3001
        run: |
          if [ -f axe-results.json ]; then
            curl -X POST http://localhost:3001/api/evidence/ci-scan \
              -H "Content-Type: application/json" \
              -d @- <<EOF
          {
            "prNumber": ${{ github.event.pull_request.number || 0 }},
            "commitSha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "passed": $([ "${{ steps.parse-results.outputs.critical }}" -eq 0 ] && echo "true" || echo "false"),
            "complianceScore": ${{ steps.parse-results.outputs.score }},
            "violations": $(cat axe-results.json | jq '.violations'),
            "criticalBlockers": ${{ steps.parse-results.outputs.critical }},
            "scanDurationMs": $(cat axe-results.json | jq '.scanDurationMs'),
            "tool": "axe-core"
          }
          EOF
          fi
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const critical = ${{ steps.parse-results.outputs.critical }};
            const high = ${{ steps.parse-results.outputs.high }};
            const medium = ${{ steps.parse-results.outputs.medium }};
            const low = ${{ steps.parse-results.outputs.low }};
            const total = ${{ steps.parse-results.outputs.total }};
            const score = ${{ steps.parse-results.outputs.score }};
            const passed = critical === 0;
            
            const statusIcon = passed ? '‚úÖ' : '‚ùå';
            const scoreColor = score >= 90 ? 'üü¢' : score >= 75 ? 'üü°' : 'üî¥';
            
            const comment = `## ${statusIcon} Accessibility Scan Results
            
            **Compliance Score:** ${scoreColor} **${score}%**
            
            ### Violations Summary
            
            | Severity | Count |
            |----------|-------|
            | üî¥ Critical | ${critical} |
            | üü† High | ${high} |
            | üü° Medium | ${medium} |
            | üü¢ Low | ${low} |
            | **Total** | **${total}** |
            
            ${critical > 0 ? `
            ### ‚ö†Ô∏è Critical Issues Must Be Fixed
            
            This PR has **${critical} critical accessibility issue(s)** that block users with disabilities.
            Please address these issues before merging.
            ` : ''}
            
            ${passed ? `
            ### ‚úÖ Status: PASSED
            
            No critical accessibility issues detected. Great job! üéâ
            ` : `
            ### ‚ùå Status: FAILED
            
            Critical accessibility issues detected. This PR cannot be merged until these are resolved.
            `}
            
            ---
            
            <details>
            <summary>üìö WCAG 2.2 AA Compliance</summary>
            
            This scan checks for compliance with:
            - WCAG 2.0 Level A & AA
            - WCAG 2.1 Level A & AA
            - WCAG 2.2 Level AA
            
            **Evidence Retention:** Results saved to Evidence Vault for 90 days
            
            **Tools Used:** axe-core automated scanner
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-scan-results
          path: axe-results.json
          retention-days: 90
      
      - name: Fail if critical issues found
        if: steps.parse-results.outputs.critical != '0'
        run: |
          echo "‚ùå BLOCKING: Found ${{ steps.parse-results.outputs.critical }} critical accessibility issues"
          echo "These issues prevent users with disabilities from accessing content."
          echo "Please fix critical issues before merging."
          exit 1
      
      - name: Cleanup
        if: always()
        run: |
          if [ ! -z "$API_PID" ]; then
            kill $API_PID || true
          fi
          if [ ! -z "$WEBAPP_PID" ]; then
            kill $WEBAPP_PID || true
          fi
