name: Continuous Health Monitoring & Alerting

on:
  schedule:
    # Run every 5 minutes during business hours (9 AM - 6 PM UTC)
    - cron: '*/5 9-18 * * 1-5'
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/alerting.yml'

env:
  ALERT_THRESHOLD_QUEUE_DEPTH: 100
  ALERT_THRESHOLD_ERROR_RATE: 0.05
  ALERT_THRESHOLD_MODEL_DRIFT: 0.15

jobs:
  health-monitoring:
    name: Health Check & Metrics Collection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check API Health
        id: health-check
        run: |
          HEALTH_URL="${{ vars.PRODUCTION_API_URL }}/health"
          RESPONSE=$(curl -s -w "\n%{http_code}" "$HEALTH_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_body=$BODY" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "status=healthy" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check Queue Depth
        id: queue-check
        run: |
          METRICS_URL="${{ vars.PRODUCTION_API_URL }}/metrics"
          QUEUE_DEPTH=$(curl -s "$METRICS_URL" | grep 'queue_depth' | awk '{print $2}' || echo "0")
          echo "queue_depth=$QUEUE_DEPTH" >> $GITHUB_OUTPUT
          
          if [ "$QUEUE_DEPTH" -gt "${{ env.ALERT_THRESHOLD_QUEUE_DEPTH }}" ]; then
            echo "queue_status=critical" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "queue_status=normal" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check Error Rate
        id: error-rate-check
        run: |
          METRICS_URL="${{ vars.PRODUCTION_API_URL }}/metrics"
          ERROR_RATE=$(curl -s "$METRICS_URL" | grep 'error_rate' | awk '{print $2}' || echo "0")
          echo "error_rate=$ERROR_RATE" >> $GITHUB_OUTPUT
          
          if (( $(echo "$ERROR_RATE > ${{ env.ALERT_THRESHOLD_ERROR_RATE }}" | bc -l) )); then
            echo "error_status=critical" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "error_status=normal" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check AI Model Drift
        id: model-drift-check
        run: |
          METRICS_URL="${{ vars.PRODUCTION_API_URL }}/metrics"
          MODEL_DRIFT=$(curl -s "$METRICS_URL" | grep 'model_drift_score' | awk '{print $2}' || echo "0")
          echo "model_drift=$MODEL_DRIFT" >> $GITHUB_OUTPUT
          
          if (( $(echo "$MODEL_DRIFT > ${{ env.ALERT_THRESHOLD_MODEL_DRIFT }}" | bc -l) )); then
            echo "drift_status=critical" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "drift_status=normal" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Trigger PagerDuty Alert on Critical Issues
        if: |
          steps.health-check.outputs.status == 'failed' ||
          steps.queue-check.outputs.queue_status == 'critical' ||
          steps.error-rate-check.outputs.error_status == 'critical' ||
          steps.model-drift-check.outputs.drift_status == 'critical'
        uses: PagerDuty/pagerduty-change-events-action@v1.1.0
        with:
          integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          custom-event: |
            {
              "routing_key": "${{ secrets.PAGERDUTY_ROUTING_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "WCAG AI Platform - Critical Alert",
                "severity": "critical",
                "source": "GitHub Actions Health Monitor",
                "component": "production-api",
                "custom_details": {
                  "health_status": "${{ steps.health-check.outputs.status }}",
                  "queue_depth": "${{ steps.queue-check.outputs.queue_depth }}",
                  "error_rate": "${{ steps.error-rate-check.outputs.error_rate }}",
                  "model_drift": "${{ steps.model-drift-check.outputs.model_drift }}",
                  "timestamp": "${{ github.event.head_commit.timestamp }}",
                  "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              }
            }

  automated-runbook-execution:
    name: Execute Automated Runbooks
    needs: health-monitoring
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Execute Runbook - Clear Cache
        id: clear-cache
        run: |
          echo "ðŸ”§ Executing runbook: Clear Application Cache"
          curl -X POST "${{ vars.PRODUCTION_API_URL }}/admin/cache/clear" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_API_KEY }}" \
            -H "Content-Type: application/json"
          echo "cache_cleared=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Execute Runbook - Restart Workers
        id: restart-workers
        run: |
          echo "ðŸ”§ Executing runbook: Restart Background Workers"
          railway restart --service=wcagaii-workers --environment=production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

      - name: Execute Runbook - Scale Up
        id: scale-up
        run: |
          echo "ðŸ”§ Executing runbook: Scale Up Resources"
          railway scale --service=wcagaii-backend --replicas=3 --environment=production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

      - name: Verify Recovery
        id: verify-recovery
        run: |
          sleep 30
          HEALTH_URL="${{ vars.PRODUCTION_API_URL }}/health"
          RESPONSE=$(curl -s -w "\n%{http_code}" "$HEALTH_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "recovery_status=success" >> $GITHUB_OUTPUT
            echo "âœ… System recovered successfully"
          else
            echo "recovery_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ System recovery failed"
            exit 1
          fi

      - name: Notify PagerDuty of Recovery
        if: steps.verify-recovery.outputs.recovery_status == 'success'
        uses: PagerDuty/pagerduty-change-events-action@v1.1.0
        with:
          integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          custom-event: |
            {
              "routing_key": "${{ secrets.PAGERDUTY_ROUTING_KEY }}",
              "event_action": "resolve",
              "payload": {
                "summary": "WCAG AI Platform - System Recovered",
                "severity": "info",
                "source": "GitHub Actions Automated Runbook",
                "custom_details": {
                  "recovery_actions": [
                    "cache_cleared: ${{ steps.clear-cache.outputs.cache_cleared }}",
                    "workers_restarted: true",
                    "scaled_up: true"
                  ]
                }
              }
            }

  model-rollback:
    name: AI Model Rollback on Drift
    needs: health-monitoring
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Model Drift Severity
        id: check-drift
        run: |
          METRICS_URL="${{ vars.PRODUCTION_API_URL }}/metrics"
          MODEL_DRIFT=$(curl -s "$METRICS_URL" | grep 'model_drift_score' | awk '{print $2}' || echo "0")
          
          if (( $(echo "$MODEL_DRIFT > 0.20" | bc -l) )); then
            echo "rollback_needed=true" >> $GITHUB_OUTPUT
          else
            echo "rollback_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Rollback to Previous Model Version
        if: steps.check-drift.outputs.rollback_needed == 'true'
        run: |
          echo "ðŸ”„ Rolling back AI model to previous stable version"
          curl -X POST "${{ vars.PRODUCTION_API_URL }}/admin/model/rollback" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "reason": "High model drift detected",
              "drift_score": "'$MODEL_DRIFT'",
              "triggered_by": "automated_health_check"
            }'

      - name: Verify Model Rollback
        if: steps.check-drift.outputs.rollback_needed == 'true'
        run: |
          sleep 15
          MODEL_VERSION=$(curl -s "${{ vars.PRODUCTION_API_URL }}/api/model/version" | jq -r '.version')
          echo "Current model version: $MODEL_VERSION"
          echo "âœ… Model rollback completed"

      - name: Send Critical Alert for Manual Review
        if: steps.check-drift.outputs.rollback_needed == 'true'
        uses: PagerDuty/pagerduty-change-events-action@v1.1.0
        with:
          integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          custom-event: |
            {
              "routing_key": "${{ secrets.PAGERDUTY_ROUTING_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "URGENT: AI Model Rolled Back Due to Drift",
                "severity": "critical",
                "source": "GitHub Actions Model Monitor",
                "component": "ai-model",
                "custom_details": {
                  "action": "Automatic rollback executed",
                  "reason": "Model drift exceeded critical threshold",
                  "next_steps": "Manual review required before re-deployment"
                }
              }
            }
