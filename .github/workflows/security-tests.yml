name: Security Tests

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    name: Security Testing Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: packages/api/package-lock.json

      - name: Install dependencies
        run: |
          cd packages/api
          npm ci

      - name: Start API server
        run: |
          cd packages/api
          JWT_SECRET=test-secret-for-ci npm run dev &
          echo $! > server.pid
          sleep 10

      - name: Wait for API to be ready
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:3001/health; do sleep 2; done'

      - name: Run security test suite
        run: |
          cd packages/api
          JWT_SECRET=test-secret-for-ci ./scripts/test-security.sh
        env:
          API_URL: http://localhost:3001

      - name: Stop API server
        if: always()
        run: |
          if [ -f packages/api/server.pid ]; then
            kill $(cat packages/api/server.pid) || true
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-test-results
          path: |
            packages/api/test-results/
            packages/api/*.log

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run npm audit
        run: |
          cd packages/api
          npm audit --production --audit-level=moderate
        continue-on-error: true

      - name: Check for high/critical vulnerabilities
        run: |
          cd packages/api
          if npm audit --production --audit-level=high 2>&1 | grep -q "high"; then
            echo "âŒ High or critical vulnerabilities found!"
            npm audit --production --audit-level=high
            exit 1
          else
            echo "âœ… No high or critical vulnerabilities found"
          fi

  code-quality:
    name: Code Quality & Security Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: packages/api/package-lock.json

      - name: Install dependencies
        run: |
          cd packages/api
          npm ci

      - name: Run TypeScript compiler
        run: |
          cd packages/api
          npm run build

      - name: Run linter (if configured)
        run: |
          cd packages/api
          npm run lint || echo "No linter configured"
        continue-on-error: true

  security-summary:
    name: Security Test Summary
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-audit, code-quality]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## ðŸ”’ Security Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tests: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Audit: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.security-scan.result }}" == "success" ] && \
             [ "${{ needs.dependency-audit.result }}" == "success" ] && \
             [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "âœ… All security checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some security checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
