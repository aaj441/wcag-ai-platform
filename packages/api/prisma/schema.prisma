// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main Scan Model with Confidence Scoring
model Scan {
  id                  String   @id @default(cuid())
  websiteUrl          String   @db.VarChar(2048)

  // Raw scan results (WCAG violations found)
  scanResults         String   @db.Text

  // Confidence Scoring (0.0-1.0)
  aiConfidenceScore   Float    @default(0.0)
  confidenceDetails   Json     @default("{}")

  // Consultant Review Fields
  reviewed            Boolean  @default(false)
  reviewedBy          String?  @db.VarChar(255)
  reviewedAt          DateTime?
  approvalStatus      String   @default("pending") // pending, approved, disputed, rejected

  // Report Generation
  reportPdf           String?  @db.VarChar(2048)
  reportGeneratedAt   DateTime?

  // Metadata
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  violations          Violation[]
  reviewLogs          ReviewLog[]

  @@index([approvalStatus])
  @@index([aiConfidenceScore])
  @@index([createdAt])
}

// WCAG Violation Details
model Violation {
  id              String   @id @default(cuid())

  // Foreign Key
  scanId          String
  scan            Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // WCAG Violation Details
  wcagCriteria    String   @db.VarChar(10) // e.g., "1.4.3", "2.1.1"
  severity        String   @db.VarChar(20) // critical, high, medium, low
  description     String   @db.Text

  // AI Confidence for Individual Violation (0.0-1.0)
  aiConfidence    Float    @default(0.0)
  humanReviewed   Boolean  @default(false)

  // Evidence
  elementSelector String?  @db.VarChar(2048)
  screenshot      String?  @db.VarChar(2048) // S3 URL
  codeSnippet     String?  @db.Text // HTML sample

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  fix             Fix?

  @@index([scanId])
  @@index([wcagCriteria])
  @@index([aiConfidence])
}

// Audit Trail for Compliance & Transparency
model ReviewLog {
  id              String   @id @default(cuid())

  // Foreign Key
  scanId          String
  scan            Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // Action Details
  action          String   @db.VarChar(50) // reviewed, approved, disputed, rejected, exported
  consultantEmail String   @db.VarChar(255)
  timestamp       DateTime @default(now())

  // Flexible details field for action-specific data
  details         Json     @default("{}")
  // Can contain: { "reason": "...", "notes": "...", "violationId": "...", etc }

  @@index([scanId])
  @@index([timestamp])
  @@index([action])
}

// Optional: Consultant Profile (future use)
model Consultant {
  id              String   @id @default(cuid())

  // Identity
  email           String   @unique @db.VarChar(255)
  name            String   @db.VarChar(255)

  // Professional Info
  wcagCertified   Boolean  @default(false)
  yearsExperience Int      @default(0)
  specialization  String?  @db.VarChar(255)

  // Status
  isActive        Boolean  @default(true)

  // Performance Metrics
  totalAuditsReviewed Int  @default(0)
  accuracyScore   Float    @default(0.0) // 0.0-1.0

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([isActive])
}

// Company Database (Global lead source)
model Company {
  id              String   @id @default(cuid())
  tenantId        String?  // NULL = global database, can be assigned to tenant

  // Identity
  name            String
  website         String   @unique @db.VarChar(2048)
  domain          String   @unique @db.VarChar(255)

  // Company Info
  industry        String   @db.VarChar(255)
  description     String?  @db.Text
  yearsInBusiness Int?
  employeeCount   Int?     // 1, 10, 50, 100, 500, 1000, 5000, 10000+
  revenue         String?  @db.VarChar(50) // "1M-10M", "10M-50M", etc

  // Contact Info
  contactEmail    String?  @db.VarChar(255)
  contactPhone    String?  @db.VarChar(20)
  linkedinUrl     String?  @db.VarChar(2048)
  crunchbaseUrl   String?  @db.VarChar(2048)

  // Sourcing
  source          String   @db.VarChar(50)  // "apollo", "hunter", "manual", "web_scrape"
  sourceId        String?  @db.VarChar(255) // ID from source (e.g., Apollo contact ID)

  // Verification
  verified        Boolean  @default(false)
  verifiedAt      DateTime?

  // Metadata
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  leads           Lead[]

  @@index([tenantId])
  @@index([industry])
  @@index([employeeCount])
  @@index([domain])
}

// Lead (Prospect from keyword search)
model Lead {
  id              String   @id @default(cuid())
  tenantId        String
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Lead Info
  name            String   @db.VarChar(255)
  email           String   @db.VarChar(255)
  title           String?  @db.VarChar(255)
  phone           String?  @db.VarChar(20)
  linkedinUrl     String?  @db.VarChar(2048)

  // Relevance
  keywordMatches  String[] // ["fintech", "accessibility"]
  relevanceScore  Float    @default(0.0)  // 0.0-1.0
  priorityTier    String   @default("medium")  // low, medium, high

  // Status
  status          String   @default("new")  // new, contacted, interested, qualified, won, lost
  lastContacted   DateTime?
  nextFollowUp    DateTime?

  // Notes & Tags
  notes           String?  @db.Text
  tags            String[]

  // Outcomes
  scansRequested  Int      @default(0)
  conversionDate  DateTime?

  // Metadata
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId, status])
  @@index([tenantId, relevanceScore])
  @@index([tenantId, createdAt])
}

// Keyword Search History (for analytics)
model KeywordSearch {
  id              String   @id @default(cuid())
  tenantId        String

  keywords        String[]
  resultsCount    Int
  leadsCreated    Int

  createdAt       DateTime @default(now())

  @@index([tenantId, createdAt])
}

// AI-Generated Fix for WCAG Violation
model Fix {
  id              String   @id @default(cuid())
  tenantId        String
  violationId     String
  violation       Violation @relation(fields: [violationId], references: [id], onDelete: Cascade)

  // Fix Details
  wcagCriteria    String   @db.VarChar(10)  // e.g., "1.4.3" (color contrast)
  issueType       String   @db.VarChar(100) // "missing_alt_text", "low_contrast", "missing_aria", etc

  // Generated Code
  codeLanguage    String   @default("html") // html, css, javascript, react, vue
  originalCode    String?  @db.Text        // Original problematic code
  fixedCode       String   @db.Text        // AI-generated fixed code
  explanation     String   @db.Text        // Why this fix works

  // Quality & Confidence
  confidenceScore Float    @default(0.0)   // 0.0-1.0: How confident is the fix correct?
  reviewStatus    String   @default("pending") // pending, approved, rejected, applied

  // Human Review
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?  @db.Text

  // GitHub Integration (Phase 2)
  githubBranchName String?
  githubPRUrl     String?
  githubCommitSha String?

  // Metadata
  generatedBy     String   @default("gpt-4") // Model used for generation
  generationCost  Float    @default(0.0)    // USD cost of generation
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  applications    FixApplication[]

  @@unique([violationId])
  @@index([tenantId, reviewStatus])
  @@index([wcagCriteria])
  @@index([confidenceScore])
}

// Track when a fix is applied
model FixApplication {
  id              String   @id @default(cuid())
  tenantId        String
  fixId           String
  fix             Fix      @relation(fields: [fixId], references: [id], onDelete: Cascade)

  // Application Details
  appliedBy       String   // User email
  appliedAt       DateTime @default(now())

  // Where it was applied
  repository      String?  // GitHub repo URL
  filePath        String?  // Path in repo
  branch          String?  // Git branch

  // Outcome
  success         Boolean  @default(true)
  errorMessage    String?  @db.Text

  // Verification
  verificationStatus String @default("pending") // pending, verified, failed
  verifiedAt      DateTime?

  metadata        Json     @default("{}")

  @@index([tenantId, appliedAt])
  @@index([fixId])
}

// Pre-built fix templates for common violations
model FixTemplate {
  id              String   @id @default(cuid())

  // Violation this template fixes
  wcagCriteria    String   @db.VarChar(10)
  issueType       String   @db.VarChar(100) // e.g., "missing_alt_text", "low_contrast"

  // Template Info
  name            String   @db.VarChar(255)
  description     String   @db.Text

  // Code Templates
  codeLanguages   String[] // ["html", "css", "javascript", "react"]
  templates       Json     // { "html": "...", "css": "...", etc }

  // Context & Examples
  examples        Json     // Before/after examples
  testCases       Json?    // How to verify the fix works

  // Usage
  usageCount      Int      @default(0)
  successRate     Float    @default(0.0) // 0-1, from actual applications

  // Maintenance
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([wcagCriteria])
  @@index([isActive])
}
