// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  firstName String?
  lastName  String?
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  lastLogin  DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizations OrganizationMember[]
  scans         Scan[]
  reports       Report[]
  sessions      UserSession[]
  auditLogs     AuditLog[]

  @@map("users")
}

model Organization {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  logo        String?
  website     String?
  plan        Plan     @default(FREE)
  maxUsers    Int      @default(5)
  maxScans    Int      @default(10)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members    OrganizationMember[]
  scans      Scan[]
  projects   Project[]

  @@map("organizations")
}

model OrganizationMember {
  id             String            @id @default(cuid())
  userId         String
  organizationId String
  role           OrgMemberRole     @default(MEMBER)
  joinedAt       DateTime          @default(now())
  
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("organization_members")
}

model Project {
  id             String   @id @default(cuid())
  name           String
  description    String?
  url            String?
  organizationId String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  scans        Scan[]

  @@map("projects")
}

model Scan {
  id             String    @id @default(cuid())
  url            String
  title          String?
  description    String?
  projectId      String?
  userId         String
  organizationId String?
  status         ScanStatus @default(PENDING)
  progress       Float     @default(0)
  totalIssues    Int       @default(0)
  criticalIssues Int       @default(0)
  seriousIssues  Int       @default(0)
  moderateIssues Int       @default(0)
  minorIssues    Int       @default(0)
  score          Float     @default(0)
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues       Issue[]
  reports      Report[]

  @@map("scans")
}

model Issue {
  id          String     @id @default(cuid())
  scanId      String
  type        IssueType
  severity    Severity
  rule        String
  selector    String?
  message     String
  impact      String?
  help        String?
  helpUrl     String?
  xpath       String?
  screenshot  String?
  element     Json?
  context     Json?
  tags        String[]
  wcagLevel   String?
  wcagSection String?
  createdAt   DateTime   @default(now())

  // Relations
  scan Scan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@map("issues")
}

model Report {
  id          String      @id @default(cuid())
  scanId      String      @unique
  userId      String
  name        String
  description String?
  format      ReportFormat @default(PDF)
  status      ReportStatus @default(PENDING)
  fileUrl     String?
  fileSize    Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  scan Scan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@map("reports")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?
  action    String
  resource  String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime    @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// Enums
enum UserRole {
  ADMIN
  USER
}

enum OrgMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

enum ScanStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum IssueType {
  VIOLATION
  WARNING
  INFO
  PASS
}

enum Severity {
  CRITICAL
  SERIOUS
  MODERATE
  MINOR
}

enum ReportFormat {
  PDF
  HTML
  CSV
  JSON
}

enum ReportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}