// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main Scan Model with Confidence Scoring
model Scan {
  id                  String   @id @default(cuid())
  websiteUrl          String   @db.VarChar(2048)

  // Multi-Tenant Relation (Optional - for paid clients)
  clientId          String?   @db.VarChar(255)
  client            Client?   @relation(fields: [clientId], references: [id])

  // Raw scan results (WCAG violations found)
  scanResults         String   @db.Text

  // Confidence Scoring (0.0-1.0)
  aiConfidenceScore   Float    @default(0.0)
  confidenceDetails   Json     @default("{}")

  // Consultant Review Fields
  reviewed            Boolean  @default(false)
  reviewedBy          String?  @db.VarChar(255)
  reviewedAt          DateTime?
  approvalStatus      String   @default("pending") // pending, approved, disputed, rejected

  // Report Generation
  reportPdf           String?  @db.VarChar(2048)
  reportGeneratedAt   DateTime?

  // Metadata
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  violations          Violation[]
  reviewLogs          ReviewLog[]

  @@index([approvalStatus])
  @@index([aiConfidenceScore])
  @@index([createdAt])
  @@index([clientId])
}

// WCAG Violation Details
model Violation {
  id              String   @id @default(cuid())

  // Foreign Key
  scanId          String
  scan            Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // WCAG Violation Details
  wcagCriteria    String   @db.VarChar(10) // e.g., "1.4.3", "2.1.1"
  severity        String   @db.VarChar(20) // critical, high, medium, low
  description     String   @db.Text

  // AI Confidence for Individual Violation (0.0-1.0)
  aiConfidence    Float    @default(0.0)
  humanReviewed   Boolean  @default(false)

  // Evidence
  elementSelector String?  @db.VarChar(2048)
  screenshot      String?  @db.VarChar(2048) // S3 URL
  codeSnippet     String?  @db.Text // HTML sample

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([scanId])
  @@index([wcagCriteria])
  @@index([aiConfidence])
}

// Audit Trail for Compliance & Transparency
model ReviewLog {
  id              String   @id @default(cuid())

  // Foreign Key
  scanId          String
  scan            Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // Action Details
  action          String   @db.VarChar(50) // reviewed, approved, disputed, rejected, exported
  consultantEmail String   @db.VarChar(255)
  timestamp       DateTime @default(now())

  // Flexible details field for action-specific data
  details         Json     @default("{}")
  // Can contain: { "reason": "...", "notes": "...", "violationId": "...", etc }

  @@index([scanId])
  @@index([timestamp])
  @@index([action])
}

// Optional: Consultant Profile (future use)
model Consultant {
  id              String   @id @default(cuid())

  // Identity
  email           String   @unique @db.VarChar(255)
  name            String   @db.VarChar(255)

  // Professional Info
  wcagCertified   Boolean  @default(false)
  yearsExperience Int      @default(0)
  specialization  String?  @db.VarChar(255)

  // Status
  isActive        Boolean  @default(true)

  // Performance Metrics
  totalAuditsReviewed Int  @default(0)
  accuracyScore   Float    @default(0.0) // 0.0-1.0

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([isActive])
}

// Multi-Tenant Client Management
model Client {
  id                String    @id @default(cuid())

  // Identity
  email             String    @unique @db.VarChar(255)
  company           String    @db.VarChar(255)

  // Subscription & Billing
  tier              String    @default("free") @db.VarChar(50) // free, starter, pro, enterprise
  scansRemaining    Int       @default(5) // Decremented with each scan
  subscriptionId    String?   @db.VarChar(255) // Stripe subscription ID
  stripeCustomerId  String?   @unique @db.VarChar(255)

  // Status
  status            String    @default("active") @db.VarChar(50) // active, suspended, cancelled

  // API Access
  apiKey            String?   @unique @db.VarChar(255)

  // Metadata
  metadata          Json      @default("{}")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  scans             Scan[]

  @@index([email])
  @@index([stripeCustomerId])
  @@index([apiKey])
  @@index([status])
}

// Target Demographic - Industry Categories
model Industry {
  id                    String   @id @default(cuid())
  name                  String   @unique @db.VarChar(255)
  description           String?  @db.Text

  // Risk & Characteristics
  adariskLevel          String   @default("medium") @db.VarChar(50) // low, medium, high
  typicalRevenueMin     Int      @default(1000000)
  typicalRevenueMax     Int      @default(10000000)
  typicalEmployeeMin    Int      @default(5)
  typicalEmployeeMax    Int      @default(100)

  // Tech Adoption Profile
  techOrientationScore  Float    @default(0.5) // 0.0 (not tech-oriented) to 1.0 (highly tech-oriented)
  techAdoptionSpeed     String   @default("slow") @db.VarChar(50) // slow, medium, fast
  isBlueCollar          Boolean  @default(true)

  // Metadata
  location              String?  @db.VarChar(255) // Pittsburgh, Ohio, etc.
  notes                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  targetBusinesses      TargetBusiness[]
  icpProfiles           IdealCustomerProfile[]

  @@index([adariskLevel])
  @@index([techOrientationScore])
  @@index([techAdoptionSpeed])
  @@index([name])
}

// Target Demographic - Individual Businesses
model TargetBusiness {
  id                    String   @id @default(cuid())
  name                  String   @db.VarChar(255)
  website               String?  @db.VarChar(2048)

  // Industry Relation
  industryId            String
  industry              Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)

  // Location
  location              String   @db.VarChar(255)
  city                  String   @db.VarChar(100)
  state                 String   @db.VarChar(2)

  // Business Details
  revenue               Int?
  employeeCount         Int?

  // Contact Information
  ownerName             String?  @db.VarChar(255)
  email                 String?  @db.VarChar(255)
  phone                 String?  @db.VarChar(20)

  // WCAG Accessibility Status
  wcagScore             Float?
  wcagViolationCount    Int      @default(0)
  lastScanned           DateTime?

  // Targeting & Outreach
  matchScore            Float    @default(0.0) // 0.0-1.0 how well they match ideal profile
  outreachStatus        String   @default("not_contacted") @db.VarChar(50) // not_contacted, contacted, interested, client, rejected
  outreachAttempts      Int      @default(0)
  lastOutreachDate      DateTime?
  notes                 String?  @db.Text

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  violations            TargetBusinessViolation[]
  metadata              TargetBusinessMetadata?
  contactPersons        ContactPerson[]

  @@unique([website])
  @@index([industryId])
  @@index([city])
  @@index([wcagScore])
  @@index([matchScore])
  @@index([outreachStatus])
  @@index([createdAt])
}

// Target Business WCAG Violations
model TargetBusinessViolation {
  id                    String   @id @default(cuid())
  businessId            String
  business              TargetBusiness @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Violation Details
  wcagCriteria          String   @db.VarChar(10)
  severity              String   @db.VarChar(20)
  description           String   @db.Text
  count                 Int      @default(1)

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([businessId])
  @@index([wcagCriteria])
  @@index([severity])
}

// ============================================================================
// METROPOLITAN AREA & ICP MODELS
// ============================================================================

// Geographic Market Definition
model MetropolitanArea {
  id                          String   @id @default(cuid())
  name                        String   @unique @db.VarChar(255) // "Pittsburgh Metro", "Chicago Metro"
  marketCode                  String   @unique @db.VarChar(10) // "PIT", "CHI"
  region                      String   @db.VarChar(50) // Northeast, Midwest, South, West

  // Geographic & Demographic Data
  population                  Int      // Metropolitan area population
  avgMedianHouseholdIncome    Int      // For targeting affluent areas
  businessDensityIndex        Float    // SMBs per 10,000 population

  // Tech & Market Maturity
  techAdoptionIndex           Float    @default(0.5) // 0-1 scale, how quickly tech is adopted
  averageWebsiteQuality       Float    @default(0.4) // 0-1 scale, typical website quality
  averageBusinessMaturity     Float    @default(0.5) // 0-1 scale

  // Market Size Indicators
  estimatedSmallBusinessCount Int      // Estimated SMBs in metro

  // Metadata
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  // Relations
  icpProfiles                 IdealCustomerProfile[]
  targetBusinesses            TargetBusiness[]

  @@index([region])
  @@index([techAdoptionIndex])
  @@index([businessDensityIndex])
}

// Ideal Customer Profile (ICP) - defines perfect target per metro
model IdealCustomerProfile {
  id                        String   @id @default(cuid())
  name                      String   @db.VarChar(255) // "Medical Practice - Pittsburgh"
  description               String?  @db.Text

  // Relationship to industry and metro
  industryId                String
  industry                  Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)

  metropolitanAreaId        String
  metropolitanArea          MetropolitanArea @relation(fields: [metropolitanAreaId], references: [id], onDelete: Cascade)

  // Company Profile
  revenueMin                Int      @default(1000000)
  revenueMax                Int      @default(10000000)
  employeeCountMin          Int      @default(5)
  employeeCountMax          Int      @default(100)

  // Tech & Compliance Profile
  adariskLevel              String   @default("medium") @db.VarChar(50) // low, medium, high
  techMaturityScore         Float    @default(0.3) // 0-1, how tech-savvy
  averageWebsiteAgeYears    Float    @default(8.0) // How old are typical websites

  // Sales & Business Metrics
  estimatedAnnualWcagSpend  Int      @default(0) // Estimated budget for WCAG compliance
  estimatedSalesCycle       Int      @default(30) // Days to close
  closingRate               Float    @default(0.15) // Estimated conversion rate

  // Market Opportunity
  estimatedTAM              Int      @default(0) // Total addressable market (count of ideal customers in metro)
  estimatedSOM              Int      @default(0) // Serviceable obtainable market (realistic capture)

  // Messaging & Strategy
  commonPains               String   @db.Text // JSON array: ["ADA lawsuit risk", "outdated website", ...]
  keyMotivations            String   @db.Text // JSON array: ["compliance", "online bookings", ...]
  idealMessage              String?  @db.Text // Pitch that resonates
  competitiveAdvantage      String?  @db.Text

  // Metadata
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  targetBusinesses          TargetBusiness[]

  @@unique([industryId, metropolitanAreaId])
  @@index([adariskLevel])
  @@index([techMaturityScore])
  @@index([estimatedTAM])
}

// Decision Maker Personas
model DecisionMaker {
  id                        String   @id @default(cuid())
  title                     String   @unique @db.VarChar(255) // "Practice Owner/DMD", "Operations Manager"

  // Role Definition
  role                      String   @db.VarChar(50) // owner, operations, marketing, it, finance
  roleDescription           String?  @db.Text
  influenceLevel            Int      @default(3) // 1-5, how much they influence purchase

  // Buying Profile
  decisionMakingAuthority   String   @db.VarChar(50) // sole_decision, key_influencer, implementer, budget_holder
  typicalDayToDayPain       String?  @db.Text // What frustrates them daily

  // Pain Points & Motivations (JSON arrays)
  painPoints                String   @db.Text // ["website crashes", "no online bookings", "ADA risk"]
  motivations               String   @db.Text // ["avoid lawsuits", "increase revenue", "improve reputation"]
  purchaseDrivers           String   @db.Text // What triggers purchase decision

  // Engagement Profile
  preferredOutreachChannel  String   @db.VarChar(50) // email, phone, linkedin, in-person
  bestTimeToReach           String?  @db.VarChar(100) // "Tuesday-Thursday 10am-11am"
  contentPreference         String   @db.VarChar(50) // technical, business, case_studies, roi

  // Context
  typicalSalaryRange        String?  @db.VarChar(100) // For understanding budget authority
  reportingStructure        String?  @db.Text // Who they report to

  // Metadata
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  contactPersons            ContactPerson[]

  @@index([role])
  @@index([influenceLevel])
}

// Real Contact Person at a Business
model ContactPerson {
  id                        String   @id @default(cuid())
  businessId                String
  targetBusiness            TargetBusiness @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Decision Maker Type
  decisionMakerId           String
  decisionMaker             DecisionMaker @relation(fields: [decisionMakerId], references: [id])

  // Personal Information
  firstName                 String   @db.VarChar(100)
  lastName                  String   @db.VarChar(100)
  jobTitle                  String   @db.VarChar(255)
  email                     String?  @db.VarChar(255)
  phone                     String?  @db.VarChar(20)
  linkedinUrl               String?  @db.VarChar(500)

  // Outreach Tracking
  outreachStatus            String   @default("not_contacted") @db.VarChar(50) // not_contacted, contacted, interested, client
  outreachAttempts          Int      @default(0)
  lastContactDate           DateTime?
  nextFollowUpDate          DateTime?

  // Engagement
  engagementLevel           Float    @default(0.0) // 0-1 scale
  responseRate              Float    @default(0.0)
  notes                     String?  @db.Text

  // Metadata
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@unique([businessId, decisionMakerId, email])
  @@index([businessId])
  @@index([decisionMakerId])
  @@index([outreachStatus])
  @@index([email])
}

// Update TargetBusiness to link to ICP and Metro
model TargetBusinessMetadata {
  id                        String   @id @default(cuid())
  businessId                String   @unique
  targetBusiness            TargetBusiness @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Geographic & ICP Link
  metropolitanAreaId        String
  metropolitanArea          MetropolitanArea @relation(fields: [metropolitanAreaId], references: [id])

  icpProfileId              String?
  icpProfile                IdealCustomerProfile? @relation(fields: [icpProfileId], references: [id])

  // ICP Match Score (0-1.0) - how well they fit the ideal profile
  icpMatchScore             Float    @default(0.0)

  // Decision Makers at this Business
  contactPersons            ContactPerson[]

  // Key Metrics for Targeting
  estimatedDecisionCycle    Int?     // Days to close for this specific business
  buyingSignals             String?  @db.Text // JSON array: ["recently funded", "hired marketing manager", ...]

  // Metadata
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@index([metropolitanAreaId])
  @@index([icpProfileId])
  @@index([icpMatchScore])
}
