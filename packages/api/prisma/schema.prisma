// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main Scan Model with Confidence Scoring
model Scan {
  id                  String   @id @default(cuid())
  websiteUrl          String   @db.VarChar(2048)

  // Multi-Tenant Relation (Optional - for paid clients)
  clientId          String?   @db.VarChar(255)
  client            Client?   @relation(fields: [clientId], references: [id])

  // Raw scan results (WCAG violations found)
  scanResults         String   @db.Text

  // Confidence Scoring (0.0-1.0)
  aiConfidenceScore   Float    @default(0.0)
  confidenceDetails   Json     @default("{}")

  // Consultant Review Fields
  reviewed            Boolean  @default(false)
  reviewedBy          String?  @db.VarChar(255)
  reviewedAt          DateTime?
  approvalStatus      String   @default("pending") // pending, approved, disputed, rejected

  // Report Generation
  reportPdf           String?  @db.VarChar(2048)
  reportGeneratedAt   DateTime?

  // Metadata
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  violations          Violation[]
  reviewLogs          ReviewLog[]

  @@index([approvalStatus])
  @@index([aiConfidenceScore])
  @@index([createdAt])
  @@index([clientId])
}

// WCAG Violation Details
model Violation {
  id              String   @id @default(cuid())

  // Foreign Key
  scanId          String
  scan            Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // WCAG Violation Details
  wcagCriteria    String   @db.VarChar(10) // e.g., "1.4.3", "2.1.1"
  severity        String   @db.VarChar(20) // critical, high, medium, low
  description     String   @db.Text

  // AI Confidence for Individual Violation (0.0-1.0)
  aiConfidence    Float    @default(0.0)
  humanReviewed   Boolean  @default(false)

  // Evidence
  elementSelector String?  @db.VarChar(2048)
  screenshot      String?  @db.VarChar(2048) // S3 URL
  codeSnippet     String?  @db.Text // HTML sample

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  fix             Fix?

  @@index([scanId])
  @@index([wcagCriteria])
  @@index([aiConfidence])
}

// Audit Trail for Compliance & Transparency
model ReviewLog {
  id              String   @id @default(cuid())

  // Foreign Key
  scanId          String
  scan            Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // Action Details
  action          String   @db.VarChar(50) // reviewed, approved, disputed, rejected, exported
  consultantEmail String   @db.VarChar(255)
  timestamp       DateTime @default(now())

  // Flexible details field for action-specific data
  details         Json     @default("{}")
  // Can contain: { "reason": "...", "notes": "...", "violationId": "...", etc }

  @@index([scanId])
  @@index([timestamp])
  @@index([action])
}

// Optional: Consultant Profile (future use)
model Consultant {
  id              String   @id @default(cuid())

  // Identity
  email           String   @unique @db.VarChar(255)
  name            String   @db.VarChar(255)

  // Professional Info
  wcagCertified   Boolean  @default(false)
  yearsExperience Int      @default(0)
  specialization  String?  @db.VarChar(255)

  // Status
  isActive        Boolean  @default(true)

  // Performance Metrics
  totalAuditsReviewed Int  @default(0)
  accuracyScore   Float    @default(0.0) // 0.0-1.0

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([isActive])
}

// Company Database (Global lead source)
model Company {
  id              String   @id @default(cuid())
  tenantId        String?  // NULL = global database, can be assigned to tenant

  // Identity
  name            String
  website         String   @unique @db.VarChar(2048)
  domain          String   @unique @db.VarChar(255)

  // Company Info
  industry        String   @db.VarChar(255)
  description     String?  @db.Text
  yearsInBusiness Int?
  employeeCount   Int?     // 1, 10, 50, 100, 500, 1000, 5000, 10000+
  revenue         String?  @db.VarChar(50) // "1M-10M", "10M-50M", etc

  // Contact Info
  contactEmail    String?  @db.VarChar(255)
  contactPhone    String?  @db.VarChar(20)
  linkedinUrl     String?  @db.VarChar(2048)
  crunchbaseUrl   String?  @db.VarChar(2048)

  // Sourcing
  source          String   @db.VarChar(50)  // "apollo", "hunter", "manual", "web_scrape"
  sourceId        String?  @db.VarChar(255) // ID from source (e.g., Apollo contact ID)

  // Verification
  verified        Boolean  @default(false)
  verifiedAt      DateTime?

  // Metadata
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  leads           Lead[]

  @@index([tenantId])
  @@index([industry])
  @@index([employeeCount])
  @@index([domain])
}

// Lead (Prospect from keyword search)
model Lead {
  id              String   @id @default(cuid())
  tenantId        String
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Lead Info
  name            String   @db.VarChar(255)
  email           String   @db.VarChar(255)
  title           String?  @db.VarChar(255)
  phone           String?  @db.VarChar(20)
  linkedinUrl     String?  @db.VarChar(2048)

  // Relevance
  keywordMatches  String[] // ["fintech", "accessibility"]
  relevanceScore  Float    @default(0.0)  // 0.0-1.0
  priorityTier    String   @default("medium")  // low, medium, high

  // Status
  status          String   @default("new")  // new, contacted, interested, qualified, won, lost
  lastContacted   DateTime?
  nextFollowUp    DateTime?

  // Notes & Tags
  notes           String?  @db.Text
  tags            String[]

  // Outcomes
  scansRequested  Int      @default(0)
  conversionDate  DateTime?

  // Metadata
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId, status])
  @@index([tenantId, relevanceScore])
  @@index([tenantId, createdAt])
}

// Keyword Search History (for analytics)
model KeywordSearch {
  id              String   @id @default(cuid())
  tenantId        String

  keywords        String[]
  resultsCount    Int
  leadsCreated    Int

  createdAt       DateTime @default(now())

  @@index([tenantId, createdAt])
}

// AI-Generated Fix for WCAG Violation
model Fix {
  id              String   @id @default(cuid())
  tenantId        String
  violationId     String
  violation       Violation @relation(fields: [violationId], references: [id], onDelete: Cascade)

  // Fix Details
  wcagCriteria    String   @db.VarChar(10)  // e.g., "1.4.3" (color contrast)
  issueType       String   @db.VarChar(100) // "missing_alt_text", "low_contrast", "missing_aria", etc

  // Generated Code
  codeLanguage    String   @default("html") // html, css, javascript, react, vue
  originalCode    String?  @db.Text        // Original problematic code
  fixedCode       String   @db.Text        // AI-generated fixed code
  explanation     String   @db.Text        // Why this fix works

  // Quality & Confidence
  confidenceScore Float    @default(0.0)   // 0.0-1.0: How confident is the fix correct?
  reviewStatus    String   @default("pending") // pending, approved, rejected, applied

  // Human Review
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?  @db.Text

  // GitHub Integration (Phase 2)
  githubBranchName String?
  githubPRUrl     String?
  githubCommitSha String?

  // Metadata
  generatedBy     String   @default("gpt-4") // Model used for generation
  generationCost  Float    @default(0.0)    // USD cost of generation
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  applications    FixApplication[]

  @@unique([violationId])
  @@index([tenantId, reviewStatus])
  @@index([wcagCriteria])
  @@index([confidenceScore])
}

// Track when a fix is applied
model FixApplication {
  id              String   @id @default(cuid())
  tenantId        String
  fixId           String
  fix             Fix      @relation(fields: [fixId], references: [id], onDelete: Cascade)

  // Application Details
  appliedBy       String   // User email
  appliedAt       DateTime @default(now())

  // Where it was applied
  repository      String?  // GitHub repo URL
  filePath        String?  // Path in repo
  branch          String?  // Git branch

  // Outcome
  success         Boolean  @default(true)
  errorMessage    String?  @db.Text

  // Verification
  verificationStatus String @default("pending") // pending, verified, failed
  verifiedAt      DateTime?

  metadata        Json     @default("{}")

  @@index([tenantId, appliedAt])
  @@index([fixId])
}

// Pre-built fix templates for common violations
model FixTemplate {
  id              String   @id @default(cuid())

  // Violation this template fixes
  wcagCriteria    String   @db.VarChar(10)
  issueType       String   @db.VarChar(100) // e.g., "missing_alt_text", "low_contrast"

  // Template Info
  name            String   @db.VarChar(255)
  description     String   @db.Text

  // Code Templates
  codeLanguages   String[] // ["html", "css", "javascript", "react"]
  templates       Json     // { "html": "...", "css": "...", etc }

  // Context & Examples
  examples        Json     // Before/after examples
  testCases       Json?    // How to verify the fix works

  // Usage
  usageCount      Int      @default(0)
  successRate     Float    @default(0.0) // 0-1, from actual applications

  // Maintenance
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([wcagCriteria])
  @@index([isActive])
}

// ============================================================================
// NATIONWIDE DEMOGRAPHIC TARGETING SYSTEM
// ============================================================================

// Metropolitan Area Configuration (350+ US metros)
model Metro {
  id                    String   @id @default(cuid())
  metroId               String   @unique @db.VarChar(100) // e.g., "denver-co", "nyc-ny"
  name                  String   @db.VarChar(255) // "Denver, CO"
  state                 String   @db.VarChar(2)
  population            Int
  businessCount         Int      @default(0) // Estimated total businesses
  adaLawsuitTrend       String   @default("stable") // increasing, stable, decreasing
  regionalHooks         String[] // ["Colorado tech boom", "Denver small business growth"]
  dataSourcesAvailable  String[] // ["Chamber", "BBB", "LinkedIn", "ZocDoc"]

  // Relationships
  industries            IndustryProfile[]
  prospects             Prospect[]
  lawsuits              Lawsuit[]

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([state])
  @@index([population])
  @@index([adaLawsuitTrend])
  // Composite index for filtering
  @@index([state, adaLawsuitTrend])
}

// Industry Vertical Profile per Metro
model IndustryProfile {
  id                    String   @id @default(cuid())
  metroId               String
  metro                 Metro    @relation(fields: [metroId], references: [id], onDelete: Cascade)

  verticalId            String   @db.VarChar(100) // "medical", "legal", "financial"
  name                  String   @db.VarChar(255) // "Medical & Dental"
  subCategories         String[] // ["dental", "orthopedic", "pediatric"]
  estimatedProspectsInMetro Int
  adaRiskLevel          String   @default("medium") // critical, high, medium, low
  typicalRevenue        String?  // "$1M-$5M"
  typicalEmployeeCount  Int      @default(0)
  recentLawsuitCount    Int      @default(0) // past 24 months
  searchQueries         String[] // Google search patterns
  keyDirectories        String[] // ZocDoc, HealthGrades, etc

  // Relationship
  prospects             Prospect[]

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([metroId, verticalId])
  @@index([metroId])
  @@index([adaRiskLevel])
}

// Prospect (Target Company)
model Prospect {
  id                    String   @id @default(cuid())
  metroId               String
  metro                 Metro    @relation(fields: [metroId], references: [id], onDelete: Cascade)

  industryId            String
  industry              IndustryProfile @relation(fields: [industryId], references: [id], onDelete: Cascade)

  // Business Info
  businessName          String   @db.VarChar(500)
  industry              String   @db.VarChar(100)
  website               String   @unique @db.VarChar(2048)
  ownerName             String?  @db.VarChar(255)
  email                 String?  @db.VarChar(255)
  phone                 String?  @db.VarChar(20)
  address               String?  @db.VarChar(500)
  city                  String   @db.VarChar(100)

  // Business Intelligence
  revenue               String?  // "$1M-$5M"
  employeeCount         Int?
  foundedYear           Int?
  websiteLastUpdated    DateTime?

  // Compliance & Scanning
  complianceScore       Int      @default(0) // 0-100
  violationCount        Int      @default(0)
  redFlags              String[] // ["non-responsive", "no-alt-text", "outdated-copyright"]
  lastScanned           DateTime?
  audit                 AccessibilityAudit?

  // Risk & Scoring
  riskScore             Int      @default(50) // 1-100 (lawsuit probability)
  priority              Int      @default(2) // 1 = highest, 3 = lowest
  suggestedHook         String?  // "lawsuit-risk", "peer-pressure", "trust", "compliance"

  // Outreach
  emailsSent            Int      @default(0)
  lastContacted         DateTime?
  responseStatus        String?  // "no_response", "interested", "not_interested", "converted"
  outreachEmails        OutreachEmail[]
  personalizedEmails    PersonalizedEmail[]
  outreachEnrollments   OutreachEnrollment[]
  mlPredictions         MLPrediction[]

  // Metadata
  dataSource            String   @default("auto-discovery") // "auto-discovery", "manual", "import"
  sourceUrl             String?  @db.VarChar(2048)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([metroId])
  @@index([industryId])
  @@index([priority])
  @@index([riskScore])
  @@index([complianceScore])
  @@index([responseStatus])
  @@index([city])
  // Composite indexes for performance (<5s query requirement)
  @@index([metroId, priority, riskScore])
  @@index([metroId, industryId, riskScore])
  @@index([metroId, complianceScore])
}

// Accessibility Audit Results
model AccessibilityAudit {
  id                    String   @id @default(cuid())
  prospectId            String   @unique
  prospect              Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Scan Results
  violations            Json     // Array of violations from axe-core
  redFlags              String[]
  accessibilityScore    Int
  wcagLevel             String?  // "A", "AA", "AAA"

  // Device Testing
  mobileResponsive      Boolean  @default(false)
  viewportMeta          Boolean  @default(false)
  hasHttps              Boolean  @default(false)

  // Performance
  pageLoadTime          Int?     // milliseconds
  lighthouseScore       Int?     // 0-100

  // Screenshots
  beforeScreenshot      String?  @db.VarChar(2048) // S3 URL
  afterScreenshot       String?  @db.VarChar(2048) // S3 URL

  // Metadata
  scannedAt             DateTime @default(now())
  scanStatus            String   @default("completed") // "pending", "in_progress", "completed", "failed"
  scanError             String?  @db.Text

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([prospectId])
  @@index([scannedAt])
}

// Outreach Email Tracking
model OutreachEmail {
  id                    String   @id @default(cuid())
  prospectId            String
  prospect              Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Email Content
  subject               String   @db.VarChar(500)
  body                  String   @db.Text
  hook                  String   @db.VarChar(100) // "lawsuit-risk", "peer-pressure", etc
  localReferences       String[] // ["Colorado tech boom mention"]

  // Delivery
  status                String   @default("draft") // "draft", "scheduled", "sent", "bounced", "opened", "clicked"
  scheduledFor          DateTime?
  sentAt                DateTime?
  bouncedAt             DateTime?

  // Engagement
  openCount             Int      @default(0)
  clickCount            Int      @default(0)
  responseReceived      Boolean  @default(false)
  responseReceivedAt    DateTime?

  // Tracking
  trackingId            String?  @unique @db.VarChar(255)
  emailProvider         String?  @db.VarChar(50) // "sendgrid", "mailgun", etc

  // Metadata
  generatedBy           String?  // Template ID or manual
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([prospectId])
  @@index([status])
  @@index([sentAt])
// Multi-Tenant Client Management
model Client {
  id                String    @id @default(cuid())

  // Identity
  email             String    @unique @db.VarChar(255)
  company           String    @db.VarChar(255)

  // Subscription & Billing
  tier              String    @default("basic") // basic, pro, enterprise
  scansRemaining    Int       @default(10)
  subscriptionId    String?   @db.VarChar(255)
  stripeCustomerId  String?   @db.VarChar(255)

  // Status
  status            String    @default("active") // active, inactive, suspended

  // API Access
  apiKey            String?   @unique @db.VarChar(255)

  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  scans             Scan[]

  @@index([email])
  @@index([stripeCustomerId])
  @@index([apiKey])
}

// Target Demographic - Industry Categories
model Industry {
  id                    String   @id @default(cuid())
  name                  String   @unique @db.VarChar(255)
  description           String?  @db.Text

  // Risk & Characteristics
  adariskLevel          String   @default("medium") @db.VarChar(50) // low, medium, high
  typicalRevenueMin     Int      @default(1000000)
  typicalRevenueMax     Int      @default(10000000)
  typicalEmployeeMin    Int      @default(5)
  typicalEmployeeMax    Int      @default(100)

  // Tech Adoption Profile
  techOrientationScore  Float    @default(0.5) // 0.0 (not tech-oriented) to 1.0 (highly tech-oriented)
  techAdoptionSpeed     String   @default("slow") @db.VarChar(50) // slow, medium, fast
  isBlueCollar          Boolean  @default(true)

  // Metadata
  location              String?  @db.VarChar(255) // Pittsburgh, Ohio, etc.
  notes                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  targetBusinesses      TargetBusiness[]

  @@index([adariskLevel])
  @@index([techOrientationScore])
  @@index([techAdoptionSpeed])
  @@index([name])
}

// Target Demographic - Individual Businesses
model TargetBusiness {
  id                    String   @id @default(cuid())
  name                  String   @db.VarChar(255)
  website               String?  @db.VarChar(2048)

  // Industry Relation
  industryId            String
  industry              Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)

  // Location
  location              String   @db.VarChar(255)
  city                  String   @db.VarChar(100)
  state                 String   @db.VarChar(2)

  // Business Details
  revenue               Int?
  employeeCount         Int?

  // Contact Information
  ownerName             String?  @db.VarChar(255)
  email                 String?  @db.VarChar(255)
  phone                 String?  @db.VarChar(20)

  // WCAG Accessibility Status
  wcagScore             Float?
  wcagViolationCount    Int      @default(0)
  lastScanned           DateTime?

  // Targeting & Outreach
  matchScore            Float    @default(0.0) // 0.0-1.0 how well they match ideal profile
  outreachStatus        String   @default("not_contacted") @db.VarChar(50) // not_contacted, contacted, interested, client, rejected
  outreachAttempts      Int      @default(0)
  lastOutreachDate      DateTime?
  notes                 String?  @db.Text

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  violations            TargetBusinessViolation[]

  @@unique([website])
  @@index([industryId])
  @@index([city])
  @@index([wcagScore])
  @@index([matchScore])
  @@index([outreachStatus])
  @@index([createdAt])
}

// Target Business WCAG Violations
model TargetBusinessViolation {
  id                    String   @id @default(cuid())
  businessId            String
  business              TargetBusiness @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Violation Details
  wcagCriteria          String   @db.VarChar(10)
  severity              String   @db.VarChar(20)
  description           String   @db.Text
  count                 Int      @default(1)

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([businessId])
  @@index([wcagCriteria])
  @@index([severity])
}

// ============================================================================
// ENHANCEMENT 1: REAL DATA INTEGRATIONS
// ============================================================================

// API Integration Logs (track API usage and costs)
model APIIntegrationLog {
  id                String   @id @default(cuid())
  provider          String   @db.VarChar(50) // "apollo", "hunter", "google_maps", "clearbit"
  endpoint          String   @db.VarChar(255)
  requestData       Json
  responseData      Json?
  status            String   @db.VarChar(20) // "success", "failed", "rate_limited"
  costUsd           Float    @default(0.0)
  responseTimeMs    Int
  errorMessage      String?  @db.Text
  createdAt         DateTime @default(now())

  @@index([provider, createdAt])
  @@index([status])
}

// ============================================================================
// ENHANCEMENT 2: AI-POWERED EMAIL PERSONALIZATION
// ============================================================================

// Personalized Email Templates (AI-generated)
model PersonalizedEmail {
  id                String   @id @default(cuid())
  prospectId        String
  prospect          Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Email Content (AI-generated)
  subjectLines      String[] // 5 variants for A/B testing
  emailBody         String   @db.Text
  hook              String   @db.VarChar(100) // "lawsuit-risk", "peer-pressure", etc
  personalizationFactors Json // What made this unique (e.g., {"website_issues": ["no_alt_text"], "local_context": "Denver lawsuits"})

  // AI Generation Details
  aiModel           String   @default("gpt-4") @db.VarChar(50)
  generationCost    Float    @default(0.0)
  confidenceScore   Float    @default(0.0) // 0.0-1.0 how confident AI is

  // Performance Tracking
  sentVariant       Int?     // Which subject line was used (0-4)
  opened            Boolean  @default(false)
  clicked           Boolean  @default(false)
  replied           Boolean  @default(false)
  converted         Boolean  @default(false)

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([prospectId])
  @@index([hook])
  @@index([opened, clicked, replied])
}

// ============================================================================
// ENHANCEMENT 3: REAL-TIME LAWSUIT TRACKING
// ============================================================================

// ADA Lawsuit Records
model Lawsuit {
  id                String   @id @default(cuid())

  // Case Details
  caseNumber        String   @unique @db.VarChar(100)
  plaintiffName     String   @db.VarChar(255)
  defendantName     String   @db.VarChar(255)
  defendantWebsite  String?  @db.VarChar(2048)
  defendantIndustry String?  @db.VarChar(100)

  // Location
  metroId           String?
  metro             Metro?   @relation(fields: [metroId], references: [id])
  court             String   @db.VarChar(255)
  state             String   @db.VarChar(2)

  // Case Status
  filedDate         DateTime
  status            String   @default("active") @db.VarChar(50) // active, settled, dismissed, won_defendant, won_plaintiff
  settlementAmount  Float?   // USD, if known
  closedDate        DateTime?

  // Violation Details
  violations        String[] // WCAG criteria violated
  allegationType    String   @db.VarChar(100) // "Title III ADA", "Section 508", etc

  // Law Firm
  plaintiffLawFirm  String?  @db.VarChar(255)
  defendantLawFirm  String?  @db.VarChar(255)

  // Source
  dataSource        String   @db.VarChar(50) // "seyfarth", "usablenet", "manual", "scraper"
  sourceUrl         String?  @db.VarChar(2048)

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([metroId, filedDate])
  @@index([defendantIndustry, filedDate])
  @@index([status])
  @@index([filedDate])
  @@index([state])
}

// ============================================================================
// ENHANCEMENT 4: AUTOMATED OUTREACH SEQUENCING
// ============================================================================

// Outreach Sequence Configuration
model OutreachSequence {
  id                String   @id @default(cuid())

  // Sequence Details
  name              String   @db.VarChar(255)
  description       String?  @db.Text
  triggerEvent      String   @db.VarChar(100) // "audit_complete", "high_risk_score", "no_response_3days"
  targetIndustries  String[] // Filter which industries this applies to
  targetRiskScore   Int?     // Minimum risk score to trigger

  // Status
  isActive          Boolean  @default(true)

  // Performance Metrics
  totalProspects    Int      @default(0)
  totalSent         Int      @default(0)
  totalOpened       Int      @default(0)
  totalClicked      Int      @default(0)
  totalReplied      Int      @default(0)
  totalConverted    Int      @default(0)

  // Relations
  steps             OutreachStep[]
  enrollments       OutreachEnrollment[]

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isActive])
  @@index([triggerEvent])
}

// Individual Steps in Sequence
model OutreachStep {
  id                String   @id @default(cuid())
  sequenceId        String
  sequence          OutreachSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  // Step Configuration
  stepNumber        Int      // 1, 2, 3, etc
  channel           String   @db.VarChar(20) // "email", "sms", "linkedin", "voicemail"
  delayDays         Int      // Days after previous step (0 for first step)
  delayHours        Int      @default(0) // Additional hours

  // Content
  subject           String?  @db.VarChar(500) // For email
  body              String   @db.Text
  templateVariables Json     @default("{}") // Variables to replace (e.g., {{firstName}})

  // Conditions
  sendCondition     String?  @db.VarChar(100) // "if_not_opened", "if_not_clicked", "always"

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([sequenceId, stepNumber])
}

// Prospect Enrollment in Sequence
model OutreachEnrollment {
  id                String   @id @default(cuid())
  prospectId        String
  prospect          Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  sequenceId        String
  sequence          OutreachSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  // Status
  status            String   @default("active") @db.VarChar(50) // active, paused, completed, unsubscribed
  currentStep       Int      @default(0)

  // Tracking
  enrolledAt        DateTime @default(now())
  lastStepSentAt    DateTime?
  nextStepScheduledAt DateTime?
  completedAt       DateTime?
  unsubscribedAt    DateTime?

  // Performance
  stepsCompleted    Int      @default(0)
  emailsOpened      Int      @default(0)
  emailsClicked     Int      @default(0)
  replied           Boolean  @default(false)
  converted         Boolean  @default(false)

  // Relations
  activities        OutreachActivity[]

  @@unique([prospectId, sequenceId])
  @@index([sequenceId, status])
  @@index([nextStepScheduledAt])
}

// Individual Outreach Activities (sent messages)
model OutreachActivity {
  id                String   @id @default(cuid())
  enrollmentId      String
  enrollment        OutreachEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  // Activity Details
  stepNumber        Int
  channel           String   @db.VarChar(20) // "email", "sms", "linkedin"
  subject           String?  @db.VarChar(500)
  body              String   @db.Text

  // Delivery
  status            String   @default("pending") @db.VarChar(50) // pending, sent, delivered, bounced, failed
  scheduledFor      DateTime
  sentAt            DateTime?
  deliveredAt       DateTime?

  // Engagement
  opened            Boolean  @default(false)
  openedAt          DateTime?
  clicked           Boolean  @default(false)
  clickedAt         DateTime?
  replied           Boolean  @default(false)
  repliedAt         DateTime?

  // External IDs (from SendGrid, Twilio, etc)
  externalId        String?  @db.VarChar(255)
  externalProvider  String?  @db.VarChar(50)

  // Metadata
  errorMessage      String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([enrollmentId])
  @@index([scheduledFor])
  @@index([status])
}

// ============================================================================
// ENHANCEMENT 5: PREDICTIVE ML LEAD SCORING
// ============================================================================

// ML Model Metadata
model MLModel {
  id                String   @id @default(cuid())

  // Model Details
  name              String   @db.VarChar(255)
  version           String   @db.VarChar(50)
  algorithm         String   @db.VarChar(100) // "xgboost", "random_forest", "logistic_regression"
  targetVariable    String   @db.VarChar(100) // "conversion_probability"

  // Training Details
  trainingDataSize  Int      // Number of records
  trainingStartedAt DateTime
  trainingCompletedAt DateTime?
  trainingDurationSec Int?

  // Performance Metrics
  accuracy          Float?   // 0.0-1.0
  precision         Float?
  recall            Float?
  f1Score           Float?
  auc               Float?   // Area Under Curve

  // Feature Importance
  featureImportance Json     // {"industry": 0.35, "violations": 0.25, ...}

  // Model Storage
  modelPath         String?  @db.VarChar(500) // S3 path or file path

  // Status
  isActive          Boolean  @default(false)
  deployedAt        DateTime?

  // Relations
  predictions       MLPrediction[]

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isActive])
  @@index([version])
}

// ML Predictions for Prospects
model MLPrediction {
  id                String   @id @default(cuid())
  prospectId        String
  prospect          Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  modelId           String
  model             MLModel  @relation(fields: [modelId], references: [id])

  // Prediction Results
  conversionProbability Float // 0.0-1.0
  confidenceScore   Float    // 0.0-1.0 (how confident the model is)

  // Recommendations
  recommendedAction String   @db.VarChar(50) // "call", "email", "skip", "nurture"
  estimatedDealValue Float?  // Predicted revenue if converted

  // Feature Values (what the model saw)
  featureValues     Json     // Snapshot of prospect data at prediction time

  // Top Contributing Features
  topFeatures       Json     // [{"feature": "industry_risk", "impact": 0.35}, ...]

  // Actual Outcome (for model retraining)
  actualConverted   Boolean?
  actualDealValue   Float?
  actualConvertedAt DateTime?

  // Metadata
  predictedAt       DateTime @default(now())

  @@index([prospectId])
  @@index([modelId])
  @@index([conversionProbability])
  @@index([recommendedAction])
}
