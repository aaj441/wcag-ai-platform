// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main Scan Model with Confidence Scoring
model Scan {
  id                  String   @id @default(cuid())
  websiteUrl          String   @db.VarChar(2048)

  // Multi-Tenant Relation (Optional - for paid clients)
  clientId          String?   @db.VarChar(255)
  client            Client?   @relation(fields: [clientId], references: [id])

  // Raw scan results (WCAG violations found)
  scanResults         String   @db.Text

  // Confidence Scoring (0.0-1.0)
  aiConfidenceScore   Float    @default(0.0)
  confidenceDetails   Json     @default("{}")

  // Consultant Review Fields
  reviewed            Boolean  @default(false)
  reviewedBy          String?  @db.VarChar(255)
  reviewedAt          DateTime?
  approvalStatus      String   @default("pending") // pending, approved, disputed, rejected

  // Report Generation
  reportPdf           String?  @db.VarChar(2048)
  reportGeneratedAt   DateTime?

  // Metadata
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  violations          Violation[]
  reviewLogs          ReviewLog[]

  @@index([approvalStatus])
  @@index([aiConfidenceScore])
  @@index([createdAt])
  @@index([clientId])
}

// WCAG Violation Details
model Violation {
  id              String   @id @default(cuid())

  // Foreign Key
  scanId          String
  scan            Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // WCAG Violation Details
  wcagCriteria    String   @db.VarChar(10) // e.g., "1.4.3", "2.1.1"
  severity        String   @db.VarChar(20) // critical, high, medium, low
  description     String   @db.Text

  // AI Confidence for Individual Violation (0.0-1.0)
  aiConfidence    Float    @default(0.0)
  humanReviewed   Boolean  @default(false)

  // Evidence
  elementSelector String?  @db.VarChar(2048)
  screenshot      String?  @db.VarChar(2048) // S3 URL
  codeSnippet     String?  @db.Text // HTML sample

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([scanId])
  @@index([wcagCriteria])
  @@index([aiConfidence])
}

// Audit Trail for Compliance & Transparency
model ReviewLog {
  id              String   @id @default(cuid())

  // Foreign Key
  scanId          String
  scan            Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // Action Details
  action          String   @db.VarChar(50) // reviewed, approved, disputed, rejected, exported
  consultantEmail String   @db.VarChar(255)
  timestamp       DateTime @default(now())

  // Flexible details field for action-specific data
  details         Json     @default("{}")
  // Can contain: { "reason": "...", "notes": "...", "violationId": "...", etc }

  @@index([scanId])
  @@index([timestamp])
  @@index([action])
}

// Optional: Consultant Profile (future use)
model Consultant {
  id              String   @id @default(cuid())

  // Identity
  email           String   @unique @db.VarChar(255)
  name            String   @db.VarChar(255)

  // Professional Info
  wcagCertified   Boolean  @default(false)
  yearsExperience Int      @default(0)
  specialization  String?  @db.VarChar(255)

  // Status
  isActive        Boolean  @default(true)

  // Performance Metrics
  totalAuditsReviewed Int  @default(0)
  accuracyScore   Float    @default(0.0) // 0.0-1.0

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([isActive])
}

// Multi-Tenant Client Management
model Client {
  id                String    @id @default(cuid())

  // Identity
  email             String    @unique @db.VarChar(255)
  company           String    @db.VarChar(255)

  // Subscription & Billing
  tier              String    @default("free") @db.VarChar(50) // free, starter, pro, enterprise
  scansRemaining    Int       @default(5) // Decremented with each scan
  subscriptionId    String?   @db.VarChar(255) // Stripe subscription ID
  stripeCustomerId  String?   @unique @db.VarChar(255)

  // Status
  status            String    @default("active") @db.VarChar(50) // active, suspended, cancelled

  // API Access
  apiKey            String?   @unique @db.VarChar(255)

  // Metadata
  metadata          Json      @default("{}")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  scans             Scan[]

  @@index([email])
  @@index([stripeCustomerId])
  @@index([apiKey])
  @@index([status])
}

// Target Demographic - Industry Categories
model Industry {
  id                    String   @id @default(cuid())
  name                  String   @unique @db.VarChar(255)
  description           String?  @db.Text

  // Risk & Characteristics
  adariskLevel          String   @default("medium") @db.VarChar(50) // low, medium, high
  typicalRevenueMin     Int      @default(1000000)
  typicalRevenueMax     Int      @default(10000000)
  typicalEmployeeMin    Int      @default(5)
  typicalEmployeeMax    Int      @default(100)

  // Tech Adoption Profile
  techOrientationScore  Float    @default(0.5) // 0.0 (not tech-oriented) to 1.0 (highly tech-oriented)
  techAdoptionSpeed     String   @default("slow") @db.VarChar(50) // slow, medium, fast
  isBlueCollar          Boolean  @default(true)

  // Metadata
  location              String?  @db.VarChar(255) // Pittsburgh, Ohio, etc.
  notes                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  targetBusinesses      TargetBusiness[]

  @@index([adariskLevel])
  @@index([techOrientationScore])
  @@index([techAdoptionSpeed])
  @@index([name])
}

// Target Demographic - Individual Businesses
model TargetBusiness {
  id                    String   @id @default(cuid())
  name                  String   @db.VarChar(255)
  website               String?  @db.VarChar(2048)

  // Industry Relation
  industryId            String
  industry              Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)

  // Location
  location              String   @db.VarChar(255)
  city                  String   @db.VarChar(100)
  state                 String   @db.VarChar(2)

  // Business Details
  revenue               Int?
  employeeCount         Int?

  // Contact Information
  ownerName             String?  @db.VarChar(255)
  email                 String?  @db.VarChar(255)
  phone                 String?  @db.VarChar(20)

  // WCAG Accessibility Status
  wcagScore             Float?
  wcagViolationCount    Int      @default(0)
  lastScanned           DateTime?

  // Targeting & Outreach
  matchScore            Float    @default(0.0) // 0.0-1.0 how well they match ideal profile
  outreachStatus        String   @default("not_contacted") @db.VarChar(50) // not_contacted, contacted, interested, client, rejected
  outreachAttempts      Int      @default(0)
  lastOutreachDate      DateTime?
  notes                 String?  @db.Text

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  violations            TargetBusinessViolation[]

  @@unique([website])
  @@index([industryId])
  @@index([city])
  @@index([wcagScore])
  @@index([matchScore])
  @@index([outreachStatus])
  @@index([createdAt])
}

// Target Business WCAG Violations
model TargetBusinessViolation {
  id                    String   @id @default(cuid())
  businessId            String
  business              TargetBusiness @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Violation Details
  wcagCriteria          String   @db.VarChar(10)
  severity              String   @db.VarChar(20)
  description           String   @db.Text
  count                 Int      @default(1)

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([businessId])
  @@index([wcagCriteria])
  @@index([severity])
}
